<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>系统后台配置 - AI 圆桌会</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <script src="talentPool.js"></script>
    <script src="api.js"></script>

    <style>
        /* 基础移动端优化 */
        body { -webkit-tap-highlight-color: transparent; }
        
        /* 隐藏默认滚动条但保留功能 */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* 自定义滚动条样式 (PC端显示) */
        @media (min-width: 768px) {
            ::-webkit-scrollbar { width: 6px; height: 6px; }
            ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
            ::-webkit-scrollbar-track { background: transparent; }
        }
        
        .fade-enter-active, .fade-leave-active { transition: opacity 0.2s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }

        .slide-enter-active, .slide-leave-active { transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        .slide-enter-from, .slide-leave-to { transform: translateX(100%); }
    </style>
</head>
<body class="bg-slate-100 text-gray-700 font-sans h-[100dvh] flex flex-col overflow-hidden">

<div id="app" class="flex flex-col h-full max-w-7xl mx-auto w-full bg-white relative shadow-2xl">
    
    <header class="bg-slate-800 text-white px-4 md:px-6 py-3 md:py-4 flex justify-between items-center shrink-0 z-20 shadow-md">
        <div class="flex items-center gap-2 md:gap-3">
            <div class="bg-blue-500 w-8 h-8 md:w-9 md:h-9 rounded-lg flex items-center justify-center shrink-0">
                <i class="fa-solid fa-sliders text-white text-sm"></i>
            </div>
            <div class="leading-tight">
                <h1 class="font-bold text-base md:text-lg">配置中心</h1>
                <p class="text-[10px] opacity-50 uppercase tracking-wider font-semibold hidden md:block">Admin Panel</p>
            </div>
        </div>
        
        <div class="flex bg-slate-700/50 rounded-lg p-1 backdrop-blur-sm">
            <button @click="switchTab('models')" :class="currentTab==='models' ? 'bg-blue-600 text-white shadow-md' : 'text-gray-400 hover:text-white'" class="px-3 md:px-5 py-1.5 md:py-2 rounded-md text-xs md:text-sm font-bold transition flex items-center gap-1.5 md:gap-2">
                <i class="fa-solid fa-cubes"></i> <span>模型</span>
            </button>
            <button @click="switchTab('talents')" :class="currentTab==='talents' ? 'bg-indigo-600 text-white shadow-md' : 'text-gray-400 hover:text-white'" class="px-3 md:px-5 py-1.5 md:py-2 rounded-md text-xs md:text-sm font-bold transition flex items-center gap-1.5 md:gap-2">
                <i class="fa-solid fa-users"></i> <span>角色</span>
            </button>
        </div>
    </header>

    <main class="flex-1 overflow-hidden relative bg-slate-50 flex flex-col">
        
        <div class="px-4 md:px-6 py-3 md:py-4 bg-white border-b border-gray-100 flex flex-col md:flex-row gap-3 md:gap-4 justify-between items-center shrink-0 z-10">
            
            <div class="flex flex-col md:flex-row gap-2 md:gap-3 w-full md:w-auto">
                <div class="relative group w-full md:w-64">
                    <i class="fa-solid fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                    <input v-model="searchQuery" 
                           class="w-full pl-10 pr-4 h-10 bg-gray-50 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:bg-white outline-none transition appearance-none" 
                           :class="currentTab === 'models' ? 'focus:ring-blue-200 focus:border-blue-400' : 'focus:ring-indigo-200 focus:border-indigo-400'"
                           :placeholder="currentTab === 'models' ? '搜索模型、平台...' : '搜索角色、Prompt...'">
                </div>
                
                <div class="relative w-full md:w-40">
                    <i class="fa-solid fa-filter absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                    <select v-model="filterCategory" class="w-full pl-9 pr-8 h-10 bg-gray-50 border border-gray-200 rounded-lg text-sm outline-none appearance-none cursor-pointer hover:bg-white transition focus:border-blue-400">
                        <option value="">{{ currentTab === 'models' ? '所有平台' : '所有部门' }}</option>
                        <option v-for="opt in filterOptions" :key="opt" :value="opt">{{ opt }}</option>
                    </select>
                    <i class="fa-solid fa-chevron-down absolute right-3 top-1/2 -translate-y-1/2 text-xs text-gray-400 pointer-events-none"></i>
                </div>
            </div>

            <div class="grid grid-cols-2 md:flex gap-2 md:gap-3 w-full md:w-auto">
                <button @click="handleExport" class="justify-center px-4 h-10 bg-emerald-50 text-emerald-600 border border-emerald-200 rounded-lg text-sm font-bold hover:bg-emerald-100 transition flex items-center gap-2 active:scale-95">
                    <i class="fa-solid fa-download"></i> <span>导出</span>
                </button>
                <button @click="openDrawer(null)" 
                        class="justify-center px-5 h-10 text-white rounded-lg text-sm font-bold shadow-lg shadow-blue-500/30 transition flex items-center gap-2 active:scale-95"
                        :class="currentTab === 'models' ? 'bg-gradient-to-r from-blue-500 to-blue-600' : 'bg-gradient-to-r from-indigo-500 to-indigo-600'">
                    <i class="fa-solid fa-plus"></i> <span>新建</span>
                </button>
            </div>
        </div>

        <div class="flex-1 overflow-y-auto p-4 md:p-6 pb-24 md:pb-10 scroll-smooth -webkit-overflow-scrolling-touch">
            
            <div v-if="currentTab === 'models'" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 md:gap-5">
                <div v-for="item in filteredList" :key="item.id" 
                     class="bg-white border border-gray-100 rounded-xl p-4 md:p-5 shadow-sm active:scale-[0.98] transition-transform duration-100 relative group cursor-pointer"
                     @click="openDrawer(item)">
                    <div class="flex justify-between items-start mb-3">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-md text-xs font-bold bg-blue-50 text-blue-600 border border-blue-100">{{ item.platform }}</span>
                        <div class="flex gap-1">
                             <button @click.stop="deleteItem(item.id)" class="w-8 h-8 flex items-center justify-center rounded-full text-gray-400 hover:bg-red-50 hover:text-red-500 transition"><i class="fa-solid fa-trash-can"></i></button>
                        </div>
                    </div>
                    <h3 class="font-bold text-gray-800 text-lg mb-1 truncate">{{ item.model }}</h3>
                    <div class="flex items-center gap-2 text-xs text-gray-400 font-mono mb-3 bg-gray-50 p-2 rounded border border-gray-100">
                        <i class="fa-solid fa-link shrink-0"></i> <span class="truncate">{{ item.url }}</span>
                    </div>
                    
                    <div class="bg-gray-50 rounded-lg p-3 border border-gray-100 h-32" @click.stop>
                        <div class="text-xs text-gray-600 leading-relaxed whitespace-pre-wrap h-full overflow-y-auto">
                            {{ item.remark || '暂无备注说明...' }}
                        </div>
                    </div>
                </div>
                
                <div v-if="filteredList.length === 0" class="col-span-full flex flex-col items-center justify-center py-20 opacity-40">
                    <i class="fa-solid fa-server text-6xl mb-4 text-gray-300"></i>
                    <p class="font-medium text-gray-500">暂无模型配置</p>
                </div>
            </div>

            <div v-else class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 md:gap-5">
                <div v-for="t in filteredList" :key="t.id" 
                     class="bg-white border border-gray-100 rounded-xl p-4 md:p-5 shadow-sm active:scale-[0.98] transition-transform duration-100 relative group cursor-pointer"
                     @click="openDrawer(t)">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-gradient-to-br from-indigo-100 to-purple-100 text-indigo-600 flex items-center justify-center font-bold text-lg shadow-inner">{{ t.name.charAt(0) }}</div>
                            <div>
                                <div class="font-bold text-gray-800">{{ t.name }}</div>
                                <div v-if="t.category" class="text-[10px] text-gray-400 font-bold uppercase tracking-wide">{{ t.category }}</div>
                            </div>
                        </div>
                        <button @click.stop="deleteItem(t.id)" class="w-8 h-8 flex items-center justify-center rounded-full text-gray-400 hover:bg-red-50 hover:text-red-500 transition"><i class="fa-solid fa-trash-can"></i></button>
                    </div>
                    
                    <div class="bg-gray-50 rounded-lg p-3 border border-gray-100 h-32" @click.stop>
                        <div class="text-xs text-gray-600 leading-relaxed whitespace-pre-wrap h-full overflow-y-auto">
                            {{ t.prompt }}
                        </div>
                    </div>
                </div>
                
                <div v-if="filteredList.length === 0" class="col-span-full flex flex-col items-center justify-center py-20 opacity-40">
                    <i class="fa-solid fa-user-astronaut text-6xl mb-4 text-gray-300"></i>
                    <p class="font-medium text-gray-500">暂无角色配置</p>
                </div>
            </div>
        </div>

        <transition name="fade">
            <div v-if="isDrawerOpen" @click="closeDrawer" class="absolute inset-0 bg-gray-900/30 backdrop-blur-sm z-30 touch-none"></div>
        </transition>

        <transition name="slide">
            <div v-if="isDrawerOpen" class="absolute top-0 right-0 bottom-0 w-full md:w-[480px] bg-white shadow-2xl z-40 flex flex-col border-l border-gray-100">
                <div class="px-4 md:px-6 py-4 md:py-5 border-b border-gray-100 flex justify-between items-center bg-white shrink-0">
                    <div>
                        <h2 class="text-lg font-bold text-gray-800">
                            {{ form.id ? '编辑' : '新建' }}{{ currentTab === 'models' ? '模型配置' : '角色档案' }}
                        </h2>
                        <p class="text-xs text-gray-400 mt-0.5">请完善以下信息</p>
                    </div>
                    <button @click="closeDrawer" class="w-10 h-10 flex items-center justify-center rounded-full bg-gray-50 text-gray-500 active:bg-gray-200 transition">
                        <i class="fa-solid fa-times text-lg"></i>
                    </button>
                </div>

                <div class="flex-1 overflow-y-auto p-4 md:p-6 space-y-5 bg-gray-50/50 pb-20">
                    
                    <template v-if="currentTab === 'models'">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-bold text-gray-500 mb-2 uppercase">平台名称 <span class="text-red-500">*</span></label>
                                <div class="relative">
                                    <input v-model="form.platform" class="w-full border border-gray-300 rounded-lg p-3 pr-10 text-sm focus:ring-2 ring-blue-500/20 focus:border-blue-500 outline-none transition appearance-none" placeholder="输入或选择...">
                                    <div class="absolute right-1 top-1 bottom-1 w-8 flex items-center justify-center bg-gray-50 rounded text-gray-500 cursor-pointer hover:bg-gray-100">
                                        <i class="fa-solid fa-chevron-down text-xs"></i>
                                        <select @change="form.platform = $event.target.value; $event.target.value=''" class="absolute inset-0 opacity-0 w-full h-full cursor-pointer">
                                            <option value="" disabled selected>选择归属平台...</option>
                                            <option v-for="opt in filterOptions" :value="opt">{{ opt }}</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-500 mb-2 uppercase">Model ID <span class="text-red-500">*</span></label>
                                <input v-model="form.model" class="w-full border border-gray-300 rounded-lg p-3 text-sm focus:ring-2 ring-blue-500/20 focus:border-blue-500 outline-none transition appearance-none" placeholder="例如: gpt-4">
                            </div>
                        </div>

                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-2 uppercase">API URL <span class="text-red-500">*</span></label>
                            <div class="relative">
                                <i class="fa-solid fa-link absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 text-xs"></i>
                                <input v-model="form.url" class="w-full pl-9 border border-gray-300 rounded-lg p-3 text-sm font-mono text-gray-600 focus:ring-2 ring-blue-500/20 focus:border-blue-500 outline-none transition appearance-none" placeholder="https://api.openai.com/v1">
                            </div>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-2 uppercase">API Key <span class="text-red-500">*</span></label>
                            <div class="relative">
                                <i class="fa-solid fa-key absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 text-xs"></i>
                                <input v-model="form.key" type="password" class="w-full pl-9 border border-gray-300 rounded-lg p-3 text-sm font-mono text-gray-600 focus:ring-2 ring-blue-500/20 focus:border-blue-500 outline-none transition appearance-none" placeholder="sk-...">
                            </div>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-2 uppercase">备注说明</label>
                            <textarea v-model="form.remark" class="w-full border border-gray-300 rounded-lg p-3 text-sm focus:ring-2 ring-blue-500/20 focus:border-blue-500 outline-none transition resize-none h-32 appearance-none" placeholder="填写关于该模型的用途..."></textarea>
                        </div>
                    </template>

                    <template v-else>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-2 uppercase">角色名称 <span class="text-red-500">*</span></label>
                            <div class="relative">
                                <i class="fa-solid fa-user absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 text-xs"></i>
                                <input v-model="form.name" class="w-full pl-9 border border-gray-300 rounded-lg p-3 text-sm focus:ring-2 ring-indigo-500/20 focus:border-indigo-500 outline-none transition appearance-none" placeholder="例如：资深文案策划">
                            </div>
                        </div>

                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-2 uppercase">归属部门</label>
                            <div class="relative">
                                <i class="fa-solid fa-tag absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 text-xs z-10"></i>
                                <input v-model="form.category" class="w-full pl-9 border border-gray-300 rounded-lg p-3 pr-10 text-sm focus:ring-2 ring-indigo-500/20 focus:border-indigo-500 outline-none transition appearance-none" placeholder="输入或选择...">
                                <div class="absolute right-1 top-1 bottom-1 w-8 flex items-center justify-center bg-gray-50 rounded text-gray-500 cursor-pointer hover:bg-gray-100">
                                    <i class="fa-solid fa-chevron-down text-xs"></i>
                                    <select @change="form.category = $event.target.value; $event.target.value=''" class="absolute inset-0 opacity-0 w-full h-full cursor-pointer">
                                        <option value="" disabled selected>选择归属部门...</option>
                                        <option v-for="opt in filterOptions" :value="opt">{{ opt }}</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="flex-1 flex flex-col">
                            <label class="block text-xs font-bold text-gray-500 mb-2 uppercase">人设 Prompt <span class="text-red-500">*</span></label>
                            <textarea v-model="form.prompt" class="w-full border border-gray-300 rounded-lg p-4 text-sm font-mono text-gray-700 leading-relaxed focus:ring-2 ring-indigo-500/20 focus:border-indigo-500 outline-none transition resize-none min-h-[300px] appearance-none" placeholder="你是一位... 请描述该角色的详细职责..."></textarea>
                        </div>
                    </template>
                </div>

                <div class="p-4 md:p-6 border-t border-gray-100 bg-white shrink-0 pb-safe">
                    <button @click="saveItem" 
                            class="w-full py-3.5 rounded-xl text-white font-bold shadow-lg transition transform active:scale-[0.98] flex justify-center items-center gap-2 text-base"
                            :class="currentTab === 'models' ? 'bg-blue-600 hover:bg-blue-700 shadow-blue-500/30' : 'bg-indigo-600 hover:bg-indigo-700 shadow-indigo-500/30'">
                        <i class="fa-solid fa-save"></i> <span>保存配置</span>
                    </button>
                </div>
            </div>
        </transition>

    </main>
</div>

<script>
    const { createApp, ref, reactive, computed, onMounted } = Vue;

    createApp({
        setup() {
            const currentTab = ref('models');
            const searchQuery = ref('');
            const filterCategory = ref('');
            const isDrawerOpen = ref(false);

            const apiLibrary = ref([]);
            const talentPool = ref([]);
            
            const form = reactive({
                id: null,
                platform: '', model: '', url: '', key: '', remark: '',
                name: '', prompt: '', category: ''
            });

            const switchTab = (tab) => {
                currentTab.value = tab;
                searchQuery.value = '';
                filterCategory.value = '';
                isDrawerOpen.value = false;
            };

            const currentList = computed(() => currentTab.value === 'models' ? apiLibrary.value : talentPool.value);

            const filterOptions = computed(() => {
                const list = currentList.value;
                const field = currentTab.value === 'models' ? 'platform' : 'category';
                return [...new Set(list.map(item => item[field]).filter(Boolean))].sort();
            });

            const filteredList = computed(() => {
                let list = currentList.value;
                const q = searchQuery.value.toLowerCase().trim();
                const f = filterCategory.value;

                if (f) {
                    const field = currentTab.value === 'models' ? 'platform' : 'category';
                    list = list.filter(item => item[field] === f);
                }

                if (q) {
                    if (currentTab.value === 'models') {
                        list = list.filter(i => 
                            (i.model && i.model.toLowerCase().includes(q)) || 
                            (i.platform && i.platform.toLowerCase().includes(q)) ||
                            (i.remark && i.remark.toLowerCase().includes(q))
                        );
                    } else {
                        list = list.filter(t => 
                            (t.name && t.name.toLowerCase().includes(q)) || 
                            (t.prompt && t.prompt.toLowerCase().includes(q)) ||
                            (t.category && t.category.toLowerCase().includes(q))
                        );
                    }
                }
                
                return [...list].sort((a, b) => b.id - a.id);
            });

            const openDrawer = (item) => {
                Object.keys(form).forEach(k => form[k] = '');
                if (item) {
                    Object.assign(form, item);
                } else {
                    form.id = null;
                }
                isDrawerOpen.value = true;
            };

            const closeDrawer = () => isDrawerOpen.value = false;

            const saveItem = () => {
                if (currentTab.value === 'models') {
                    if (!form.platform || !form.model || !form.url || !form.key) return alert('请填写带有 * 号的必填项');
                } else {
                    if (!form.name || !form.prompt) return alert('角色名称和 Prompt 不能为空');
                }

                const targetList = currentTab.value === 'models' ? apiLibrary : talentPool;
                
                if (form.id) {
                    const idx = targetList.value.findIndex(i => i.id === form.id);
                    if (idx !== -1) targetList.value[idx] = { ...targetList.value[idx], ...form };
                } else {
                    targetList.value.push({ ...form, id: Date.now() });
                }
                closeDrawer();
            };

            const deleteItem = (id) => {
                if(!confirm('确定要删除此条目吗？')) return;
                if (currentTab.value === 'models') {
                    apiLibrary.value = apiLibrary.value.filter(i => i.id !== id);
                } else {
                    talentPool.value = talentPool.value.filter(t => t.id !== id);
                }
                if (isDrawerOpen.value && form.id === id) closeDrawer();
            };

            const handleExport = () => {
                const varName = currentTab.value === 'models' ? 'API_LIBRARY' : 'TALENT_POOL';
                const data = currentTab.value === 'models' ? apiLibrary.value : talentPool.value;
                const fileName = currentTab.value === 'models' ? 'api.js' : 'talentPool.js';
                const content = `window.${varName} = ${JSON.stringify(data, null, 4)};`;
                
                const blob = new Blob([content], { type: 'application/javascript' });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = fileName;
                a.click();
            };

            onMounted(() => {
                if (window.API_LIBRARY) apiLibrary.value = window.API_LIBRARY;
                if (window.TALENT_POOL) talentPool.value = window.TALENT_POOL;
            });

            return {
                currentTab, switchTab, searchQuery, filterCategory, filterOptions, filteredList,
                isDrawerOpen, openDrawer, closeDrawer, form, saveItem, deleteItem, handleExport
            };
        }
    }).mount('#app');
</script>
</body>
</html>