<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CodeStation - 旗舰版 (支持同名覆盖)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.23.4/ace.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        .full-modal { display: none; position: fixed; inset: 0; width: 100vw; height: 100vh; background: white; z-index: 9999; flex-direction: column; }
        #ace-editor { flex: 1; width: 100%; height: 100%; font-size: 14px; }

        /* 响应式列表网格布局 */
        .grid-layout { 
            display: grid; 
            grid-template-columns: 45px minmax(150px, 3fr) 170px 100px 90px 150px; 
            align-items: center;
            gap: 12px;
        }
        @media (max-width: 1024px) {
            .grid-layout { grid-template-columns: 40px minmax(120px, 1fr) 145px; }
            .col-hide { display: none !important; }
            .action-btns { opacity: 1 !important; transform: none !important; }
        }

        .clickable { cursor: pointer; transition: all 0.2s ease; }
        .file-item { border-left: 3px solid transparent; transition: all 0.2s; }
        .file-item.checked-row { background-color: #eff6ff !important; border-left-color: #3b82f6 !important; }
        .file-item:hover { background-color: #f8fafc; }
        
        @media (min-width: 1025px) {
            .action-btns { opacity: 0; transform: translateX(5px); }
            .file-item:hover .action-btns { opacity: 1; transform: translateX(0); }
        }

        .sort-header { cursor: pointer; user-select: none; transition: color 0.2s; white-space: nowrap; }
        .sort-header:hover { color: #3b82f6; }
        .sort-active { color: #3b82f6 !important; font-weight: 900; }

        #content-loader { display: none; position: fixed; inset: 0; background: rgba(255,255,255,0.95); z-index: 10000; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
        input[type="checkbox"] { width: 1.15rem; height: 1.15rem; cursor: pointer; accent-color: #2563eb; }
        .custom-scroll { overflow-y: auto; }
        .custom-scroll::-webkit-scrollbar { width: 4px; height: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 font-sans select-none overflow-x-hidden">

<div id="content-loader">
    <div class="flex flex-col items-center max-w-xs text-center">
        <div class="w-10 h-10 border-4 border-slate-200 border-t-blue-500 rounded-full animate-spin"></div>
        <span class="text-[10px] font-black text-slate-600 mt-4 uppercase tracking-widest" id="cl-text">准备执行任务...</span>
        <p id="cl-subtext" class="text-[8px] text-slate-400 mt-2 truncate w-full px-4 font-bold uppercase"></p>
    </div>
</div>

<div class="max-w-7xl mx-auto py-4 md:py-8 px-3 md:px-6">
    <header class="mb-6 flex flex-wrap justify-between items-center gap-4 px-2">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-slate-900 rounded-2xl flex items-center justify-center text-white shadow-lg">
                <i class="fas fa-file-import"></i>
            </div>
            <div>
                <h1 class="text-xl md:text-2xl font-black text-slate-900 tracking-tighter italic uppercase leading-none">Code<span class="text-blue-600">Station</span></h1>
                <p id="status-text" class="text-[8px] font-black text-slate-400 uppercase tracking-widest mt-1">旗舰版 · 智能冲突检测引擎</p>
            </div>
        </div>
        <button onclick="clearConfig()" class="text-[10px] font-black text-slate-400 border border-slate-200 px-4 py-2 rounded-full hover:bg-red-50 hover:text-red-500 transition clickable uppercase">重置配置</button>
    </header>

    <div class="bg-white p-5 rounded-[2.5rem] shadow-xl shadow-slate-200/50 border border-slate-100 mb-6">
        <form onsubmit="event.preventDefault(); fetchRepoContents('');" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4">
            <input id="owner" type="text" placeholder="GitHub 用户名" class="bg-slate-50 border-none p-3 rounded-2xl focus:ring-2 focus:ring-blue-400 outline-none text-sm font-medium">
            <input id="repo" type="text" placeholder="仓库名" class="bg-slate-50 border-none p-3 rounded-2xl focus:ring-2 focus:ring-blue-400 outline-none text-sm font-medium">
            <input id="token" type="password" placeholder="GitHub Token" class="bg-slate-50 border-none p-3 rounded-2xl focus:ring-2 focus:ring-blue-400 outline-none text-sm font-medium">
            <button type="submit" class="bg-slate-900 text-white font-black text-xs uppercase tracking-widest rounded-2xl hover:bg-blue-600 transition shadow-lg py-3.5 clickable">连接同步</button>
        </form>
    </div>

    <div class="flex flex-col gap-4 mb-4 bg-white p-4 rounded-[2rem] shadow-sm border border-slate-100">
        <div class="flex flex-wrap gap-2 items-center">
            <button onclick="document.getElementById('fileInputBatch').click()" class="px-5 py-2.5 bg-blue-600 text-white text-[10px] font-black rounded-xl uppercase shadow-md clickable" title="上传多个文件到当前目录">批量上传</button>
            <button onclick="document.getElementById('folderInput').click()" class="px-5 py-2.5 bg-indigo-600 text-white text-[10px] font-black rounded-xl uppercase shadow-md clickable" title="上传整个本地文件夹">目录上传</button>
            <button onclick="actionNewFolder()" class="px-5 py-2.5 text-slate-500 border border-slate-200 text-[10px] font-black rounded-xl uppercase clickable">新建目录</button>
            <div class="flex-1 hidden md:block"></div>
            <div id="batch-actions" class="hidden flex flex-wrap items-center gap-2 bg-blue-50/50 p-2 rounded-2xl border border-blue-100">
                <button onclick="batchDownload()" class="text-[9px] font-black bg-white text-blue-600 px-3 py-1.5 rounded-lg border border-blue-200 hover:bg-blue-600 hover:text-white transition clickable" title="打包选中项">打包</button>
                <button onclick="setBatchClipboard('copy')" class="text-[9px] font-black bg-white text-blue-600 px-3 py-1.5 rounded-lg border border-blue-200 hover:bg-blue-600 hover:text-white transition clickable" title="复制">复制</button>
                <button onclick="setBatchClipboard('cut')" class="text-[9px] font-black bg-white text-orange-600 px-3 py-1.5 rounded-lg border border-orange-200 hover:bg-orange-600 hover:text-white transition clickable" title="剪切">剪切</button>
                <button onclick="handleBatchDelete()" class="text-[9px] font-black bg-white text-red-600 px-3 py-1.5 rounded-lg border border-red-200 hover:bg-red-600 hover:text-white transition clickable" title="删除">删除</button>
            </div>
        </div>
        <button id="btn-paste-batch" onclick="actionBatchPaste()" class="hidden w-full py-4 bg-blue-600 text-white text-xs font-black rounded-2xl animate-pulse uppercase shadow-lg clickable">粘贴</button>
        <div class="relative w-full">
            <i class="fas fa-search absolute left-4 top-3.5 text-slate-300 text-sm"></i>
            <input id="searchInput" oninput="filterFiles()" type="text" placeholder="搜索当前列表内容..." class="w-full pl-11 pr-4 py-3 bg-slate-50 border-none rounded-2xl text-sm focus:ring-1 focus:ring-blue-200 outline-none">
        </div>
    </div>

    <div class="bg-slate-900 rounded-t-[1.5rem] border-x border-t border-slate-900 overflow-hidden">
        <div class="p-4 grid-layout items-center text-[10px] font-black text-slate-500 uppercase tracking-widest leading-none">
            <div class="flex justify-center"><input type="checkbox" id="selectAllHeader" onclick="toggleSelectAll()"></div>
            <div class="sort-header" id="header-name" onclick="handleSortClick('name')">名称 <span class="sort-icon"></span></div>
            <div class="sort-header col-hide text-center" id="header-time" onclick="handleSortClick('modified_at')">修改时间 <span class="sort-icon"></span></div>
            <div class="sort-header col-hide text-center" id="header-type" onclick="handleSortClick('type_label')">类型 <span class="sort-icon"></span></div>
            <div class="sort-header col-hide text-right" id="header-size" onclick="handleSortClick('size')">大小 <span class="sort-icon"></span></div>
            <div class="text-right pr-4 italic">操作管理</div>
        </div>
    </div>

    <div class="bg-white rounded-b-[1.5rem] shadow-xl shadow-slate-200/50 border border-slate-200 overflow-hidden min-h-[450px] relative">
        <div id="loader" class="hidden absolute inset-0 bg-white/95 z-50 flex flex-col items-center justify-center">
            <div class="w-10 h-10 border-4 border-slate-100 border-t-blue-500 rounded-full animate-spin"></div>
        </div>
        <ul id="file-list" class="divide-y divide-slate-50">
            <li class="p-24 text-center text-slate-200 font-black italic uppercase text-xs tracking-widest leading-none">请先连接 GitHub 仓库...</li>
        </ul>
    </div>
    
    <nav id="breadcrumb" class="mt-4 flex items-center text-[9px] font-black text-slate-400 px-4 py-3 bg-white border border-slate-100 rounded-full w-full overflow-x-auto whitespace-nowrap custom-scroll uppercase"></nav>
</div>

<input type="file" id="fileInputBatch" class="hidden" multiple onchange="handleBatchUpload(this.files)">
<input type="file" id="folderInput" class="hidden" webkitdirectory onchange="handleBatchUpload(this.files)">

<div id="ideModal" class="full-modal">
    <div class="h-14 bg-slate-900 text-white flex items-center justify-between px-4 shadow-lg shrink-0 border-b border-white/5">
        <button onclick="closeIDE()" class="w-10 h-10 flex items-center justify-center rounded-full hover:bg-slate-800 transition clickable"><i class="fas fa-arrow-left text-sm"></i></button>
        <span id="ide-filename" class="font-mono text-[10px] text-blue-400 truncate px-4 tracking-widest uppercase">编辑器</span>
        <button onclick="saveToGithub()" class="bg-blue-600 px-5 py-1.5 rounded-xl text-[10px] font-black uppercase shadow-lg clickable">保存</button>
    </div>
    <div id="ace-editor" class="custom-scroll"></div>
</div>

<script>
    // --- 状态管理 ---
    let currentPath = localStorage.getItem('gh_last_path') || "";
    let allFiles = [], sortConfig = { key: 'name', dir: 'asc' }; 
    let editor, activeFile, selectedItems = [], clipboard = { items: [], action: null };
    const collator = new Intl.Collator('zh-Hans-CN', { numeric: true, sensitivity: 'base' });

    window.onload = () => {
        ['owner', 'repo', 'token'].forEach(k => {
            const v = localStorage.getItem('gh_' + k);
            if (v) document.getElementById(k).value = v;
        });
        if (document.getElementById('owner').value && document.getElementById('repo').value) fetchRepoContents(currentPath);
    };

    // --- 核心：智能覆盖上传引擎 ---
    async function handleBatchUpload(fileList) {
        if (!fileList.length) return;
        const owner = localStorage.getItem('gh_owner'), repo = localStorage.getItem('gh_repo'), token = localStorage.getItem('gh_token');
        if (!token) return alert("请先配置 Token");

        const total = fileList.length;
        showContentLoader(true, "正在分析上传任务...");

        try {
            for (let i = 0; i < total; i++) {
                const file = fileList[i];
                const relPath = file.webkitRelativePath || file.name;
                const targetPath = currentPath ? `${currentPath}/${relPath}` : relPath;
                const fileName = relPath.split('/').pop();

                // 检查冲突：在当前 allFiles 列表中查找是否存在同名文件
                // 注意：对于目录上传的深层文件，GitHub 接口会直接返回冲突，这里我们主要针对当前视图层
                const existing = allFiles.find(f => f.name === fileName && f.type === 'file');
                let sha = null;

                if (existing) {
                    const confirmed = confirm(`文件 "${fileName}" 已存在。是否要覆盖原文件？`);
                    if (!confirmed) {
                        console.log(`跳过文件: ${fileName}`);
                        continue; 
                    }
                    sha = existing.sha; // 如果选择覆盖，必须提供原有文件的 SHA
                }

                document.getElementById('cl-text').innerText = `正在传送 (${i + 1}/${total})`;
                document.getElementById('cl-subtext').innerText = relPath;

                const base64 = await blobToBase64(file);
                
                await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${targetPath}`, {
                    method: 'PUT',
                    headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        message: `Upload ${relPath} (Overwrite: ${sha ? 'Yes' : 'No'})`, 
                        content: base64,
                        sha: sha // 核心关键：如果有 SHA，GitHub 才会执行更新覆盖
                    })
                });
            }
            setTimeout(() => fetchRepoContents(currentPath), 500);

        } catch (e) {
            console.error(e);
            alert("上传失败：请检查文件大小（限制 25MB）或 Token 权限。");
        } finally {
            showContentLoader(false);
        }
    }

    // --- 辅助功能 ---
    function blobToBase64(blob) {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.onloadend = () => resolve(reader.result.split(',')[1]);
            reader.readAsDataURL(blob);
        });
    }

    // --- 列表抓取与渲染 (含自动采集时间) ---
    async function fetchRepoContents(path) {
        const owner = document.getElementById('owner').value.trim(), repo = document.getElementById('repo').value.trim(), token = document.getElementById('token').value.trim();
        if (!owner || !repo) return;
        localStorage.setItem('gh_owner', owner); localStorage.setItem('gh_repo', repo); localStorage.setItem('gh_token', token);
        localStorage.setItem('gh_last_path', path); currentPath = path;
        clearSelection(); showLoader(true);
        try {
            const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}?t=${Date.now()}`, { headers: token ? { 'Authorization': `token ${token}` } : {} });
            let data = await res.json();
            if(!Array.isArray(data)) data = [data];
            data.forEach(f => { f.type_label = getFileTypeLabel(f.name, f.type === 'dir'); f.modified_at = null; });
            allFiles = data;
            applySortingAndRender(); updateBreadcrumb(path);
            autoFetchTimestamps(owner, repo, token);
        } catch (e) { alert("同步失败"); } finally { showLoader(false); }
    }

    async function autoFetchTimestamps(o, r, t) {
        const promises = allFiles.map(async (f) => {
            try {
                const res = await fetch(`https://api.github.com/repos/${o}/${r}/commits?path=${f.path}&per_page=1`, { headers: t ? { 'Authorization': `token ${t}` } : {} });
                const commits = await res.json();
                if (commits?.length) f.modified_at = commits[0].commit.committer.date;
            } catch (e) {}
        });
        await Promise.all(promises);
        applySortingAndRender();
    }

    function renderFiles(files) {
        const list = document.getElementById('file-list');
        list.innerHTML = "";
        if (currentPath) {
            const up = document.createElement('li');
            up.className = "p-4 cursor-pointer text-blue-500 font-black hover:bg-slate-50 flex items-center text-[9px] uppercase tracking-widest clickable";
            up.innerHTML = `<i class="fas fa-level-up-alt mr-3 ml-12"></i> .. 返回上级`;
            up.onclick = () => { let p = currentPath.split('/'); p.pop(); fetchRepoContents(p.join('/')); };
            list.appendChild(up);
        }
        files.forEach(file => {
            const isDir = file.type === 'dir', canEdit = file.name.match(/\.(html|css|js|md|txt|json|xml|py|php|sql|c|cpp)$/i);
            const timeStr = file.modified_at ? new Date(file.modified_at).toLocaleString('zh-CN', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', hour12: false }).replace(/\//g,'-') : '同步中...';
            const sizeStr = isDir ? '--' : (file.size/1024).toFixed(1) + ' KB';
            const isChecked = selectedItems.some(i => i.path === file.path);
            const previewUrl = `https://web.tuchong.tk/${file.path}`;

            const li = document.createElement('li');
            li.className = `file-item p-4 grid-layout clickable ${isChecked ? 'checked-row' : ''}`;
            li.innerHTML = `
                <div class="flex justify-center"><input type="checkbox" class="file-checkbox" ${isChecked?'checked':''} onclick="event.stopPropagation(); handleCheckboxChange(this, '${file.path}')"></div>
                <div class="flex items-center min-w-0" ondblclick="${isDir ? `fetchRepoContents('${file.path}')` : canEdit ? `actionEdit(${JSON.stringify(file).replace(/"/g, '&quot;')})` : ''}" onclick="handleCheckboxChange(this.previousElementSibling.firstElementChild, '${file.path}', true)">
                    <div class="w-8 h-8 rounded-lg ${isDir ? 'bg-amber-100 text-amber-500' : 'bg-slate-100 text-slate-400'} flex items-center justify-center mr-3 shrink-0 shadow-sm border border-black/5"><i class="fas ${isDir ? 'fa-folder' : 'fa-file'} text-xs"></i></div>
                    <p class="font-bold text-slate-700 text-sm truncate leading-tight">${file.name}</p>
                </div>
                <div class="col-hide text-center text-[10px] font-bold text-slate-400">${timeStr}</div>
                <div class="col-hide text-center text-[10px] font-bold text-slate-400">${file.type_label}</div>
                <div class="col-hide text-right text-[10px] font-bold text-slate-400 tabular-nums">${sizeStr}</div>
                <div class="flex justify-end gap-1.5 action-btns">
                    ${file.name.endsWith('.html') ? `<a href="${previewUrl}" target="_blank" class="w-7 h-7 rounded-lg bg-emerald-50 text-emerald-600 flex items-center justify-center hover:bg-emerald-600 hover:text-white transition shadow-sm" title="外部预览"><i class="fas fa-external-link-alt text-[9px]"></i></a>` : ''}
                    ${canEdit ? `<button onclick='actionEdit(${JSON.stringify(file).replace(/"/g, '&quot;')})' class="w-7 h-7 rounded-lg bg-blue-50 text-blue-600 flex items-center justify-center hover:bg-blue-600 hover:text-white transition shadow-sm" title="代码编辑"><i class="fas fa-edit text-[9px]"></i></button>` : ''}
                    <button onclick='${isDir ? `singleFolderDownload(${JSON.stringify(file).replace(/"/g, '&quot;')})` : `singleFileDownload(${JSON.stringify(file).replace(/"/g, '&quot;')})`}' class="w-7 h-7 rounded-lg bg-indigo-50 text-indigo-600 flex items-center justify-center hover:bg-indigo-600 hover:text-white transition shadow-sm" title="下载项"><i class="fas fa-download text-[9px]"></i></button>
                    <button onclick='actionRename(${JSON.stringify(file).replace(/"/g, '&quot;')})' class="w-7 h-7 rounded-lg bg-slate-100 text-slate-400 flex items-center justify-center hover:bg-slate-500 hover:text-white transition shadow-sm" title="重命名"><i class="fas fa-pen text-[9px]"></i></button>
                    <button onclick='handleDelete(${JSON.stringify(file).replace(/"/g, '&quot;')})' class="w-7 h-7 rounded-lg bg-red-50 text-red-600 flex items-center justify-center hover:bg-red-600 hover:text-white transition shadow-sm" title="永久删除"><i class="fas fa-trash-alt text-[9px]"></i></button>
                </div>
            `;
            list.appendChild(li);
        });
    }

    // --- 其他全递归管理逻辑 ---
    async function deleteItemRecursive(item) {
        const owner = localStorage.getItem('gh_owner'), repo = localStorage.getItem('gh_repo'), token = localStorage.getItem('gh_token');
        if (item.type === 'dir') {
            const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${item.path}`, { headers: { 'Authorization': `token ${token}` } });
            const data = await res.json();
            for (let sub of data) await deleteItemRecursive(sub);
        } else {
            document.getElementById('cl-subtext').innerText = `清理中: ${item.path}`;
            await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${item.path}`, {
                method: 'DELETE', headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: "Recursive delete", sha: item.sha })
            });
        }
    }

    async function handleBatchDelete() {
        if (!selectedItems.length || !confirm("确定要永久删除选中的所有项及其内容吗？")) return;
        showContentLoader(true, "批量清理中...");
        try { for (let item of selectedItems) await deleteItemRecursive(item); fetchRepoContents(currentPath); } 
        finally { showContentLoader(false); }
    }

    async function actionBatchPaste() {
        showContentLoader(true, clipboard.action === 'cut' ? "正在迁移..." : "正在同步...");
        try {
            async function cpDir(o, n) {
                const r = await fetch(`https://api.github.com/repos/${localStorage.getItem('gh_owner')}/${localStorage.getItem('gh_repo')}/contents/${o}`, { headers: { 'Authorization': `token ${localStorage.getItem('gh_token')}` } });
                const d = await r.json();
                for (let s of d) {
                    if(s.type === 'dir') await cpDir(s.path, `${n}/${s.name}`);
                    else {
                        const b64 = await blobToBase64(await (await fetch(s.download_url)).blob());
                        await fetch(`https://api.github.com/repos/${localStorage.getItem('gh_owner')}/${localStorage.getItem('gh_repo')}/contents/${n}/${s.name}`, { method:'PUT', headers:{'Authorization':`token ${localStorage.getItem('gh_token')}`}, body: JSON.stringify({message:"Copy", content:b64}) });
                    }
                }
            }
            for(let item of clipboard.items) {
                const target = currentPath ? `${currentPath}/${item.name}` : item.name;
                if(item.type === 'dir') await cpDir(item.path, target);
                else await fetch(`https://api.github.com/repos/${localStorage.getItem('gh_owner')}/${localStorage.getItem('gh_repo')}/contents/${target}`, { method:'PUT', headers:{'Authorization':`token ${localStorage.getItem('gh_token')}`}, body: JSON.stringify({message:"Copy", content:await blobToBase64(await (await fetch(item.download_url)).blob())}) });
                if (clipboard.action === 'cut') await deleteItemRecursive(item);
            }
            clipboard = { items: [], action: null }; document.getElementById('btn-paste-batch').classList.add('hidden'); fetchRepoContents(currentPath);
        } finally { showContentLoader(false); }
    }

    function setBatchClipboard(a) { clipboard = { items: [...selectedItems], action: a }; document.getElementById('btn-paste-batch').classList.remove('hidden'); clearSelection(); }
    function handleSortClick(k) { sortConfig.dir = (sortConfig.key===k && sortConfig.dir==='asc') ? 'desc' : 'asc'; sortConfig.key=k; applySortingAndRender(); }
    function applySortingAndRender() {
        const { key, dir } = sortConfig;
        document.querySelectorAll('.sort-header').forEach(el => el.classList.remove('sort-active'));
        document.querySelectorAll('.sort-icon').forEach(el => el.innerHTML = '');
        const activeHeader = document.getElementById(`header-${key==='modified_at'?'time':(key==='type_label'?'type':key)}`);
        if(activeHeader) { activeHeader.classList.add('sort-active'); activeHeader.querySelector('.sort-icon').innerHTML = dir==='asc'?'↑':'↓'; }
        allFiles.sort((a,b) => {
            if(a.type!==b.type) return a.type==='dir'?-1:1;
            let vA = a[key]||"", vB = b[key]||"";
            if(key==='size') { vA=parseInt(vA)||0; vB=parseInt(vB)||0; }
            if(key==='modified_at') { vA=vA?new Date(vA).getTime():0; vB=vB?new Date(vB).getTime():0; }
            return dir==='asc' ? collator.compare(vA,vB) : collator.compare(vB,vA);
        });
        renderFiles(allFiles);
    }
    function handleCheckboxChange(el, path, toggle = false) { if(toggle) el.checked = !el.checked; const item = allFiles.find(f => f.path === path); if(el.checked) { if(!selectedItems.some(i=>i.path===path)) selectedItems.push(item); } else { selectedItems = selectedItems.filter(i=>i.path!==path); } el.closest('.file-item').classList.toggle('checked-row', el.checked); document.getElementById('batch-actions').classList.toggle('hidden', !selectedItems.length); }
    function toggleSelectAll() { const check = document.getElementById('selectAllHeader').checked; selectedItems = check ? [...allFiles] : []; document.querySelectorAll('.file-checkbox').forEach(box => { box.checked = check; box.closest('.file-item').classList.toggle('checked-row', check); }); document.getElementById('batch-actions').classList.toggle('hidden', !selectedItems.length); }
    async function actionEdit(file) { activeFile = file; document.getElementById('ideModal').style.display='flex'; if (!editor) { editor = ace.edit("ace-editor"); editor.setTheme("ace/theme/tomorrow_night"); editor.setOptions({ fontSize: "15px", tabSize: 2, wrap: true }); } showContentLoader(true, "提取源码..."); const res = await fetch(file.download_url); editor.setValue(await res.text(), -1); showContentLoader(false); }
    async function saveToGithub() { const content = btoa(unescape(encodeURIComponent(editor.getValue()))); await fetch(`https://api.github.com/repos/${localStorage.getItem('gh_owner')}/${localStorage.getItem('gh_repo')}/contents/${activeFile.path}`, { method: 'PUT', headers: { 'Authorization': `token ${localStorage.getItem('gh_token')}` }, body: JSON.stringify({ message: "Update", content, sha: activeFile.sha }) }); alert("保存完成"); }
    async function actionRename(file) { const n = prompt("新名称:", file.name); if(!n || n === file.name) return; showContentLoader(true, "重命名中..."); try { if(file.type==='dir') { async function cp(o, n) { const r = await fetch(`https://api.github.com/repos/${localStorage.getItem('gh_owner')}/${localStorage.getItem('gh_repo')}/contents/${o}`, { headers: { 'Authorization': `token ${localStorage.getItem('gh_token')}` } }); const d = await r.json(); for (let s of d) { if(s.type === 'dir') await cp(s.path, `${n}/${s.name}`); else await fetch(`https://api.github.com/repos/${localStorage.getItem('gh_owner')}/${localStorage.getItem('gh_repo')}/contents/${n}/${s.name}`, { method:'PUT', headers:{'Authorization':`token ${localStorage.getItem('gh_token')}`}, body: JSON.stringify({message:"Rename", content:await blobToBase64(await (await fetch(s.download_url)).blob())}) }); } } await cp(file.path, currentPath ? currentPath+'/'+n : n); } else { const fR = await fetch(file.download_url); const b64 = await blobToBase64(await fR.blob()); await fetch(`https://api.github.com/repos/${localStorage.getItem('gh_owner')}/${localStorage.getItem('gh_repo')}/contents/${currentPath?currentPath+'/'+n:n}`, { method:'PUT', headers:{'Authorization':`token ${localStorage.getItem('gh_token')}`}, body: JSON.stringify({message:"Rename", content:b64}) }); } await deleteItemRecursive(file); fetchRepoContents(currentPath); } finally { showContentLoader(false); } }
    async function actionNewFolder() { const n = prompt("文件夹名:"); if(!n) return; showLoader(true); await fetch(`https://api.github.com/repos/${localStorage.getItem('gh_owner')}/${localStorage.getItem('gh_repo')}/contents/${currentPath?currentPath+'/'+n+'/.keep':n+'/.keep'}`, { method: 'PUT', headers: { 'Authorization': `token ${localStorage.getItem('gh_token')}` }, body: JSON.stringify({ message: "New dir", content: btoa(" ") }) }); fetchRepoContents(currentPath); }
    function handleDelete(i) { if (!confirm(`确定删除 [${i.name}]？`)) return; showContentLoader(true, "正在删除..."); deleteItemRecursive(i).then(() => fetchRepoContents(currentPath)).finally(() => showContentLoader(false)); }
    async function singleFileDownload(f) { showContentLoader(true, "下载中..."); try { const res = await fetch(f.download_url); saveAs(await res.blob(), f.name); } catch(e) { window.open(f.download_url, '_blank'); } finally { showContentLoader(false); } }
    async function singleFolderDownload(f) { selectedItems = [f]; await batchDownload(); clearSelection(); }
    async function batchDownload() { if (!selectedItems.length) return alert("请选中项"); const zip = new JSZip(), o = localStorage.getItem('gh_owner'), r = localStorage.getItem('gh_repo'), t = localStorage.getItem('gh_token'); showContentLoader(true, "打包中..."); try { async function fetchRec(p, cz) { const res = await fetch(`https://api.github.com/repos/${o}/${r}/contents/${p}`, { headers: t ? { 'Authorization': `token ${t}` } : {} }); const items = await res.json(); for (let i of items) { if (i.type === 'dir') await fetchRec(i.path, cz.folder(i.name)); else cz.file(i.name, await (await fetch(i.download_url)).blob()); } } for (let s of selectedItems) { if (s.type === 'dir') await fetchRec(s.path, zip.folder(s.name)); else zip.file(s.name, await (await fetch(s.download_url)).blob()); } saveAs(await zip.generateAsync({ type: "blob" }), `backup_${Date.now()}.zip`); } finally { showContentLoader(false); } }
    function getFileTypeLabel(n, d) { if(d) return "目录"; const e = n.split('.').pop().toLowerCase(); return {html:'HTML',js:'JS',css:'CSS',md:'MD',txt:'TXT',json:'JSON'}[e] || e.toUpperCase(); }
    function updateBreadcrumb(p) { const b = document.getElementById('breadcrumb'), items = p.split('/').filter(x => x); let h = `<span onclick="fetchRepoContents('')" class="cursor-pointer hover:text-blue-600 font-black px-1 clickable"><i class="fas fa-home mr-1"></i> ROOT</span>`; let c = ""; items.forEach(x => { c += (c ? '/' : '') + x; h += `<i class="fas fa-chevron-right mx-2 opacity-20 text-[7px]"></i><span onclick="fetchRepoContents('${c}')" class="cursor-pointer hover:text-blue-600 font-bold px-1 clickable">${x}</span>`; }); b.innerHTML = h; }
    function filterFiles() { const q = document.getElementById('searchInput').value.toLowerCase(); renderFiles(allFiles.filter(f => f.name.toLowerCase().includes(q))); }
    function closeIDE() { document.getElementById('ideModal').style.display = 'none'; document.body.style.overflow = 'auto'; }
    function showLoader(s) { document.getElementById('loader').classList.toggle('hidden', !s); if(s) document.getElementById('file-list').innerHTML=''; }
    function showContentLoader(s, t = "", sub = "") { document.getElementById('content-loader').style.display = s ? 'flex' : 'none'; document.getElementById('cl-text').innerText = t; document.getElementById('cl-subtext').innerText = sub; }
    function clearConfig() { localStorage.clear(); location.reload(); }
    function clearSelection() { selectedItems = []; if(document.getElementById('selectAllHeader')) document.getElementById('selectAllHeader').checked = false; document.getElementById('batch-actions').classList.add('hidden'); }
</script>
</body>
</html>