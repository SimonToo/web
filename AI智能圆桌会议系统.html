<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI 智能圆桌会议系统 (插话修复版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        /* 滚动条美化 */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        .clerk-bubble { border: 2px solid #8b5cf6; background-color: #f5f3ff; }
        
        .typing-dot { animation: typing 1.4s infinite ease-in-out both; }
        @keyframes typing {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }
        
        .modal-enter-active, .modal-leave-active { transition: opacity 0.3s ease; }
        .modal-enter-from, .modal-leave-to { opacity: 0; }
        
        /* 插话高亮动画 */
        .intervention-highlight { animation: flash 1s; }
        @keyframes flash {
            0% { background-color: #fee2e2; }
            100% { background-color: #fff1f2; }
        }
    </style>
</head>
<body class="bg-gray-100 h-screen overflow-hidden text-sm font-sans">

<div id="app" class="flex h-full">

    <transition name="modal">
        <div v-if="showSettings" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
            <div class="bg-white rounded-lg shadow-xl w-96 p-6 space-y-4">
                <div class="flex justify-between items-center border-b pb-2">
                    <h3 class="font-bold text-gray-700 text-lg"><i class="fa-solid fa-cog mr-2"></i>系统设置</h3>
                    <button @click="showSettings = false" class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-times"></i></button>
                </div>
                
                <div class="space-y-3">
                    <h4 class="text-xs font-bold text-gray-400 uppercase">AI 模型配置</h4>
                    <div>
                        <label class="block text-xs text-gray-600 mb-1">Base URL</label>
                        <input v-model="apiConfig.baseUrl" type="text" placeholder="默认: https://api.openai.com/v1" class="w-full p-2 border rounded text-xs focus:ring-2 ring-blue-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-xs text-gray-600 mb-1">API Key</label>
                        <input v-model="apiConfig.apiKey" type="password" placeholder="sk-..." class="w-full p-2 border rounded text-xs focus:ring-2 ring-blue-500 outline-none">
                        <p class="text-[10px] text-gray-400 mt-1">留空则使用内置模拟数据演示</p>
                    </div>
                    <div>
                        <label class="block text-xs text-gray-600 mb-1">模型名称</label>
                        <input v-model="apiConfig.model" type="text" placeholder="gpt-4, deepseek-chat" class="w-full p-2 border rounded text-xs focus:ring-2 ring-blue-500 outline-none">
                    </div>
                </div>

                <div class="space-y-3 pt-2 border-t">
                    <h4 class="text-xs font-bold text-gray-400 uppercase">功能开关</h4>
                    <div class="flex items-center justify-between">
                         <label class="text-xs text-gray-700">会议时长 (分钟)</label>
                         <input v-model.number="settings.duration" type="number" class="w-20 p-1 border rounded text-xs text-center">
                    </div>
                    <div class="flex items-center justify-between">
                        <label class="text-xs text-gray-700 flex items-center gap-1">
                            <i class="fa-solid fa-globe text-blue-500"></i> 允许联网搜索
                        </label>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" v-model="settings.webSearch" class="sr-only peer">
                            <div class="w-9 h-5 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-blue-600"></div>
                        </label>
                    </div>
                </div>

                <div class="pt-2">
                    <button @click="showSettings = false" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 rounded text-sm transition">保存配置</button>
                </div>
            </div>
        </div>
    </transition>

    <aside class="w-1/4 bg-white border-r border-gray-200 flex flex-col h-full shadow-sm z-10">
        <div class="p-4 border-b border-gray-100 flex justify-between items-center bg-gray-50">
            <h1 class="text-lg font-bold text-gray-800"><i class="fa-solid fa-users-rectangle mr-2 text-blue-600"></i>智能圆桌会议</h1>
            <button @click="showSettings = true" class="text-gray-500 hover:text-blue-600 transition p-1 rounded hover:bg-gray-200" title="系统设置">
                <i class="fa-solid fa-gear text-lg"></i>
            </button>
        </div>

        <div class="flex-1 overflow-y-auto p-4 space-y-6">
            <section>
                <h2 class="text-xs font-semibold text-gray-400 uppercase mb-2">议题与背景</h2>
                <textarea v-model="topic" placeholder="输入本次会议核心议题..." class="w-full p-2 border rounded h-24 text-xs mb-2 focus:ring-2 ring-blue-500 outline-none resize-none"></textarea>
                
                <div class="relative border-2 border-dashed border-gray-300 rounded p-4 text-center hover:bg-gray-50 transition cursor-pointer group">
                    <input type="file" @change="handleFileUpload" class="absolute inset-0 opacity-0 cursor-pointer" multiple accept=".txt,.md,.json">
                    <div class="text-gray-500 group-hover:text-blue-500">
                        <i class="fa-solid fa-cloud-upload-alt mb-1 text-xl"></i>
                        <p class="text-xs">上传背景材料 (.txt, .md)</p>
                    </div>
                </div>
                
                <div class="mt-2 space-y-1">
                    <div v-for="(file, idx) in backgroundFiles" :key="idx" class="flex justify-between items-center text-xs bg-blue-50 text-blue-700 p-1.5 rounded border border-blue-100">
                        <span class="truncate max-w-[180px]"><i class="fa-regular fa-file-lines mr-1"></i>{{ file.name }}</span>
                        <button @click="removeFile(idx)" class="text-red-400 hover:text-red-600 px-1">&times;</button>
                    </div>
                </div>
            </section>

            <hr>

            <section>
                <div class="flex justify-between items-center mb-2">
                    <h2 class="text-xs font-semibold text-gray-400 uppercase">参会人员</h2>
                    <button @click="addParticipant" class="text-blue-600 text-xs hover:underline flex items-center gap-1"><i class="fa-solid fa-plus"></i> 添加</button>
                </div>
                
                <div class="space-y-3">
                    <div class="p-2 bg-yellow-50 border border-yellow-200 rounded-md">
                        <div class="flex justify-between items-center"><span class="font-bold text-xs text-yellow-800"><i class="fa-solid fa-microphone mr-1"></i>主持人 (Host)</span> <span class="text-[10px] bg-yellow-200 px-1 rounded text-yellow-800">控场</span></div>
                    </div>
                    <div class="p-2 bg-purple-50 border border-purple-200 rounded-md">
                        <div class="flex justify-between items-center"><span class="font-bold text-xs text-purple-800"><i class="fa-solid fa-pen-nib mr-1"></i>书记员 (Clerk)</span> <span class="text-[10px] bg-purple-200 px-1 rounded text-purple-800">总结</span></div>
                    </div>

                    <div v-for="(p, index) in customParticipants" :key="index" class="p-3 border rounded-md relative group bg-white shadow-sm hover:shadow-md transition">
                        <button @click="removeParticipant(index)" class="absolute top-2 right-2 text-gray-300 hover:text-red-500 hidden group-hover:block">
                            <i class="fa-solid fa-trash-can"></i>
                        </button>
                        <div class="flex items-center gap-2 mb-2">
                            <div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 text-xs font-bold">
                                {{ p.name.charAt(0) }}
                            </div>
                            <div class="flex-1">
                                <input v-model="p.name" class="font-bold text-xs border-b w-full focus:outline-none focus:border-blue-500 pb-0.5" placeholder="角色名">
                            </div>
                        </div>
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-[10px] text-gray-500">控制权:</span>
                            <select v-model="p.type" class="text-[10px] border rounded bg-gray-50 px-1 py-0.5 outline-none">
                                <option value="ai">AI 托管</option>
                                <option value="human">人工扮演</option>
                            </select>
                        </div>
                        <textarea v-model="p.prompt" class="w-full text-[10px] text-gray-600 border p-1.5 rounded h-14 resize-none bg-gray-50 focus:bg-white focus:ring-1 ring-blue-300 outline-none" placeholder="输入人设：性格、立场、职责..."></textarea>
                    </div>
                </div>
            </section>
        </div>
    </aside>

    <main class="w-1/2 flex flex-col bg-slate-50 relative">
        <header class="h-14 border-b flex items-center justify-between px-6 bg-white shadow-sm z-10">
            <div class="flex items-center gap-3">
                <span class="px-2.5 py-1 rounded-full text-xs font-bold tracking-wide shadow-sm" :class="statusColor">
                    {{ statusText }}
                </span>
                <span class="text-xs text-gray-500 border-l pl-3">第 <span class="font-bold text-gray-800">{{ currentRound }}</span> 轮讨论</span>
                <span v-if="settings.webSearch" class="text-[10px] text-blue-600 bg-blue-50 px-1.5 py-0.5 rounded border border-blue-100" title="联网已开启">
                    <i class="fa-solid fa-globe mr-1"></i>Web On
                </span>
            </div>
            <div class="font-mono text-xl font-bold text-gray-700 tracking-wider" :class="{'text-red-500': timeLeft < 60}">
                {{ formatTime(timeLeft) }}
            </div>
        </header>

        <div id="chat-container" class="flex-1 overflow-y-auto p-6 space-y-6">
            <div v-if="messages.length === 0" class="flex flex-col items-center justify-center h-full text-gray-400">
                <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mb-4">
                    <i class="fa-solid fa-comments text-3xl text-gray-300"></i>
                </div>
                <p class="text-sm font-medium">准备就绪</p>
                <p class="text-xs mt-1">请配置角色后点击“启动会议”</p>
            </div>

            <div v-for="(msg, index) in messages" :key="index" class="flex flex-col animate-fade-in group">
                <div v-if="msg.role === '书记员'" class="mx-auto w-4/5 clerk-bubble rounded-xl p-5 shadow-sm relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-1 h-full bg-purple-500"></div>
                    <div class="flex items-center gap-2 mb-3 text-purple-700 font-bold border-b border-purple-200 pb-2">
                        <i class="fa-solid fa-scroll"></i>
                        <span>{{ msg.role }} - 阶段总结</span>
                        <span class="text-[10px] font-normal ml-auto text-purple-400">{{ msg.time }}</span>
                    </div>
                    <div class="prose prose-sm prose-purple max-w-none text-xs leading-relaxed" v-html="renderMarkdown(msg.content)"></div>
                </div>

                <div v-else-if="msg.isSearchAction" class="flex items-center gap-2 text-xs text-blue-500 ml-4 mb-1 italic opacity-80">
                    <i class="fa-solid fa-search fa-spin"></i> {{ msg.role }} 正在检索实时数据...
                </div>

                <div v-else class="flex flex-col gap-1 max-w-[85%]" :class="msg.role.includes('主持人') ? 'self-center w-3/4' : 'self-start'">
                    <div class="flex items-center gap-2 text-[10px] text-gray-500 px-1" :class="{'justify-center': msg.role.includes('主持人')}">
                        <span class="font-bold text-gray-700">{{ msg.role }}</span>
                        <span>{{ msg.time }}</span>
                    </div>
                    <div class="p-3.5 rounded-2xl shadow-sm text-gray-800 text-xs leading-relaxed border relative transition-colors duration-500" 
                         :class="[
                            msg.role.includes('主持人') ? 'bg-orange-50 border-orange-200 rounded-tr-none text-center' : 'bg-white border-gray-100 rounded-tl-none',
                            msg.isIntervention ? 'ring-2 ring-red-400 border-red-400 bg-red-50 intervention-highlight' : ''
                         ]">
                         <div v-if="msg.isIntervention" class="absolute -top-3 -right-3 bg-red-500 text-white text-[10px] px-2 py-0.5 rounded-full shadow font-bold">
                             <i class="fa-solid fa-bolt"></i> 强制插话
                         </div>
                        <div class="prose prose-sm max-w-none" v-html="renderMarkdown(msg.content)"></div>
                    </div>
                </div>
            </div>

            <div v-if="isAiTyping" class="flex items-center gap-2 text-gray-400 text-xs ml-4">
                <div class="w-6 h-6 rounded-full bg-gray-200 flex items-center justify-center text-[10px] font-bold text-gray-500">
                    {{ currentSpeakerName.charAt(0) }}
                </div>
                <span class="font-bold text-gray-600">{{ currentSpeakerName }}</span> 正在发言
                <div class="flex gap-1 ml-1">
                    <div class="w-1 h-1 bg-gray-400 rounded-full typing-dot" style="animation-delay: 0s"></div>
                    <div class="w-1 h-1 bg-gray-400 rounded-full typing-dot" style="animation-delay: 0.2s"></div>
                    <div class="w-1 h-1 bg-gray-400 rounded-full typing-dot" style="animation-delay: 0.4s"></div>
                </div>
            </div>
        </div>

        <footer class="p-4 border-t bg-white z-20 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)]">
            <div v-if="status === 'setup' || status === 'finished'" class="flex justify-center">
                <button @click="startMeeting" class="bg-blue-600 hover:bg-blue-700 text-white px-12 py-3 rounded-full shadow-lg hover:shadow-xl transition flex items-center gap-2 text-sm font-bold transform hover:-translate-y-0.5">
                    <i class="fa-solid fa-play"></i> {{ status === 'setup' ? '启动圆桌会议' : '开启新会议' }}
                </button>
            </div>

            <div v-else class="flex flex-col gap-3">
                <div v-if="waitingForHuman" class="flex gap-2 animate-pulse bg-green-50 p-1 rounded-md border border-green-200 items-center">
                    <span class="text-xs font-bold text-green-700 px-2 py-1 bg-green-200 rounded whitespace-nowrap">轮到: {{ currentSpeakerName }}</span>
                    <input v-model="humanInput" @keyup.enter="submitHumanInput" type="text" class="flex-1 text-sm bg-transparent outline-none text-gray-700 placeholder-green-700/50" placeholder="请输入您的观点...">
                    <button @click="submitHumanInput" class="text-green-600 hover:text-green-800 px-3"><i class="fa-solid fa-paper-plane"></i></button>
                </div>

                <div v-else class="flex gap-2 items-center">
                     <div class="relative flex-1">
                        <i class="fa-solid fa-bolt absolute left-3 top-2.5 text-gray-400 text-xs"></i>
                        <input v-model="interventionText" @keyup.enter="triggerIntervention" type="text" class="w-full border rounded-full pl-8 pr-4 py-2 text-xs focus:ring-2 ring-red-200 outline-none bg-gray-50 focus:bg-white transition" placeholder="强制插话 (AI将停止当前话题并优先响应)...">
                     </div>
                     <button @click="triggerIntervention" class="bg-white hover:bg-red-50 text-red-500 border border-red-200 px-4 py-2 rounded-full text-xs font-bold whitespace-nowrap transition shadow-sm hover:shadow">
                         插话
                     </button>
                </div>

                <div class="flex justify-between items-center border-t pt-2 border-gray-100">
                    <div class="flex gap-2">
                        <button @click="togglePause" class="text-gray-600 hover:text-blue-600 text-xs bg-gray-100 hover:bg-blue-50 px-4 py-1.5 rounded-md transition flex items-center gap-2">
                            <i class="fa-solid" :class="paused ? 'fa-play' : 'fa-pause'"></i> 
                            {{ paused ? '继续会议' : '暂停会议' }}
                        </button>
                        <button @click="endMeeting" class="text-gray-500 hover:text-red-600 text-xs hover:bg-red-50 px-4 py-1.5 rounded-md transition flex items-center gap-2">
                            <i class="fa-solid fa-stop"></i> 结束
                        </button>
                    </div>
                    <div class="text-[10px] text-gray-400 flex items-center gap-2">
                        <span v-if="!paused" class="flex h-2 w-2 relative">
                          <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                          <span class="relative inline-flex rounded-full h-2 w-2 bg-green-500"></span>
                        </span>
                        当前发言: {{ currentSpeakerName || '准备中' }}
                    </div>
                </div>
            </div>
        </footer>
    </main>

    <aside class="w-1/4 bg-white border-l border-gray-200 flex flex-col h-full shadow-sm z-10">
        <div class="p-4 border-b bg-gray-50 flex items-center justify-between">
            <h3 class="font-bold text-gray-700 text-xs uppercase"><i class="fa-solid fa-clipboard-list mr-2 text-purple-600"></i>实时白板</h3>
            <span class="text-[10px] text-gray-400 bg-white px-2 py-0.5 rounded border">Sync</span>
        </div>
        
        <div class="flex-1 overflow-y-auto p-4 space-y-4 bg-white">
            <div v-if="finalReport" class="p-4 bg-green-50 border border-green-200 rounded-lg shadow-sm animate-fade-in relative">
                <div class="absolute -top-3 left-4 bg-green-600 text-white text-[10px] px-2 py-0.5 rounded shadow-sm">
                    FINAL REPORT
                </div>
                <h4 class="font-bold text-green-800 text-sm mb-3 mt-1 border-b border-green-200 pb-2">会议最终纪要</h4>
                <div class="prose prose-xs prose-green max-w-none" v-html="renderMarkdown(finalReport)"></div>
                <div class="mt-4 pt-2 border-t border-green-200 text-center">
                    <button @click="exportReport" class="w-full text-xs bg-white border border-green-300 text-green-700 px-3 py-1.5 rounded hover:bg-green-600 hover:text-white transition flex items-center justify-center gap-2">
                        <i class="fa-solid fa-download"></i> 导出 Markdown
                    </button>
                </div>
            </div>

            <div v-for="(summary, idx) in summaries" :key="idx" class="p-3 bg-gray-50 border border-gray-200 rounded-lg text-xs hover:border-purple-300 transition group">
                <div class="flex justify-between text-gray-400 mb-2 pb-1 border-b border-gray-100">
                    <span class="font-bold text-gray-600 group-hover:text-purple-600 transition">第 {{ summary.round }} 轮小结</span>
                    <span>{{ summary.time }}</span>
                </div>
                <div class="prose prose-xs text-gray-600" v-html="renderMarkdown(summary.content)"></div>
            </div>

            <div v-if="summaries.length === 0 && !finalReport" class="text-center mt-20 opacity-50">
                <i class="fa-regular fa-clipboard text-4xl text-gray-300 mb-2"></i>
                <p class="text-xs text-gray-400">暂无记录<br>等待书记员产出...</p>
            </div>
        </div>
    </aside>

</div>

<script>
    const { createApp, ref, computed, reactive, nextTick } = Vue;

    createApp({
        setup() {
            // --- UI 状态 ---
            const showSettings = ref(false);
            const status = ref('setup'); 
            const paused = ref(false);
            const topic = ref('如何利用生成式 AI 优化企业内部知识管理？');
            
            // --- 配置 ---
            const apiConfig = reactive({
                baseUrl: '',
                apiKey: '',
                model: 'gpt-3.5-turbo'
            });
            const settings = reactive({
                duration: 30, 
                webSearch: false
            });
            
            // --- 角色 ---
            const customParticipants = ref([
                { name: 'CTO', type: 'ai', prompt: '你是一个务实的技术总监，关注数据安全、私有化部署成本，对云服务持谨慎态度。' },
                { name: '运营总监', type: 'ai', prompt: '你关注效率提升和员工上手难度，希望工具越简单越好，不关心底层技术。' }
            ]);

            // --- 运行时数据 ---
            const messages = ref([]);
            const summaries = ref([]);
            const backgroundFiles = ref([]);
            const currentRound = ref(1);
            const speakerIndex = ref(-1);
            const finalReport = ref(null);
            
            const isAiTyping = ref(false);
            const humanInput = ref('');
            const interventionText = ref('');
            const timeLeft = ref(settings.duration * 60);
            
            // 计时器引用
            let timerInterval = null;
            let turnTimer = null; 

            // --- 计算属性 ---
            const allRoles = computed(() => customParticipants.value);

            const currentSpeakerName = computed(() => {
                if (status.value === 'setup') return '';
                if (status.value === 'finished') return '会议结束';
                if (speakerIndex.value === -1) return '主持人';
                if (speakerIndex.value === allRoles.value.length) return '书记员';
                return allRoles.value[speakerIndex.value]?.name || '未知';
            });

            const waitingForHuman = computed(() => {
                if (paused.value || status.value !== 'running') return false;
                if (speakerIndex.value >= 0 && speakerIndex.value < allRoles.value.length) {
                    return allRoles.value[speakerIndex.value].type === 'human';
                }
                return false;
            });

            const statusText = computed(() => {
                if (paused.value) return '暂停中';
                if (status.value === 'running') return '进行中';
                if (status.value === 'finished') return '已结束';
                return '设置中';
            });

            const statusColor = computed(() => {
                if (paused.value) return 'bg-yellow-100 text-yellow-700';
                if (status.value === 'running') return 'bg-green-100 text-green-700 animate-pulse';
                if (status.value === 'finished') return 'bg-gray-200 text-gray-700';
                return 'bg-blue-100 text-blue-700';
            });

            // --- 方法 ---

            const startMeeting = () => {
                if (!topic.value.trim()) return alert("请输入会议议题");
                if (customParticipants.value.length === 0) return alert("请至少添加一名参会人员");
                
                showSettings.value = false;
                status.value = 'running';
                paused.value = false;
                timeLeft.value = settings.duration * 60;
                messages.value = [];
                summaries.value = [];
                finalReport.value = null;
                currentRound.value = 1;
                
                if (timerInterval) clearInterval(timerInterval);
                timerInterval = setInterval(() => {
                    if (!paused.value && status.value === 'running') {
                        timeLeft.value--;
                        if (timeLeft.value <= 0) endMeeting();
                    }
                }, 1000);

                addMessage('主持人', `各位好。本次会议议题为：**${topic.value}**。\n\n规则：请基于背景材料发言。${settings.webSearch ? '（注：系统已授权联网搜索权限，必要时可引用实时数据）' : ''}`, true);
                
                speakerIndex.value = 0;
                processTurn();
            };

            const processTurn = async () => {
                if (status.value !== 'running' || paused.value) return;

                const roles = allRoles.value;
                const idx = speakerIndex.value;

                if (idx >= roles.length) {
                    await performClerkSummary();
                    return;
                }

                const currentRole = roles[idx];
                
                if (currentRole.type === 'human') {
                    // 等待 UI
                } else {
                    isAiTyping.value = true;
                    scrollToBottom();
                    await generateAIResponse(currentRole);
                    isAiTyping.value = false;
                    nextTurn();
                }
            };

            const nextTurn = () => {
                if (status.value !== 'running') return;
                speakerIndex.value++;
                // 允许插话取消此定时器
                turnTimer = setTimeout(() => processTurn(), 800);
            };

            const generateAIResponse = async (role) => {
                const systemContext = `你正在参加圆桌会议。角色：${role.name}。人设：${role.prompt}。
                议题：${topic.value}。
                背景材料摘要：${backgroundFiles.value.map(f => f.content).join('\n').substring(0, 800)}...
                当前系统状态：[联网搜索: ${settings.webSearch ? 'ON' : 'OFF'}]`;
                
                const lastSummary = summaries.value.length > 0 ? summaries.value[summaries.value.length - 1].content : "无（首轮）";
                const currentRoundLog = messages.value
                    .filter(m => m.round === currentRound.value)
                    .map(m => `${m.role}: ${m.content}`)
                    .join('\n');

                // 核心修复：更强烈的插话检测与 Prompt 构建
                const lastMsg = messages.value[messages.value.length - 1];
                const isIntervention = lastMsg && lastMsg.isIntervention;
                
                let instruction = `请以"${role.name}"身份发言。观点需简练、符合人设。`;
                
                // 将插话指令放在最后，利用近因效应
                let promptTail = "";
                
                if (isIntervention) {
                    promptTail = `
                    \n\n!!! 紧急指令 (HIGHEST PRIORITY) !!!
                    上一条消息是【主持人】的强制插话 (Intervention)。
                    你必须 **无视所有轮次规则和话题惯性**。
                    请直接、正面回答主持人的问题或执行指令。
                    不要说“根据上一位发言”，要说“收到主持人的指示”。
                    `;
                }

                const prompt = `
                [上一轮小结]: ${lastSummary}
                [本轮对话]: ${currentRoundLog}
                
                ${instruction}
                ${settings.webSearch && !isIntervention ? '如果需要最新数据，请模拟搜索动作。' : ''}
                ${promptTail}`;

                if (settings.webSearch && Math.random() > 0.7 && !apiConfig.apiKey && !isIntervention) {
                    messages.value.push({
                        role: role.name, content: '', time: new Date().toLocaleTimeString(),
                        isSearchAction: true, round: currentRound.value
                    });
                    await new Promise(r => setTimeout(r, 1000));
                }

                const responseText = await callLLM(systemContext, prompt);
                addMessage(role.name, responseText);
            };

            const triggerIntervention = () => {
                if (!interventionText.value.trim()) return;
                
                // 1. 插入消息
                messages.value.push({
                    role: '主持人 (插话)', 
                    content: interventionText.value,
                    time: new Date().toLocaleTimeString(), 
                    round: currentRound.value,
                    isIntervention: true
                });
                
                interventionText.value = '';
                scrollToBottom();

                // 2. 核心修复：立即打断并强制接管
                if (!isAiTyping.value && status.value === 'running') {
                    if (turnTimer) clearTimeout(turnTimer); // 停止等待
                    
                    // 防止索引指向书记员，导致插话被书记员总结吞掉
                    // 如果当前轮到书记员(越界)，则强制指派给最后一个发言者来回答插话
                    if (speakerIndex.value >= allRoles.value.length) {
                         speakerIndex.value = Math.max(0, allRoles.value.length - 1);
                    }
                    
                    console.log("主持人插话，强制触发 AI 响应...");
                    processTurn(); 
                }
            };

            const performClerkSummary = async () => {
                isAiTyping.value = true;
                const roundLog = messages.value
                    .filter(m => m.round === currentRound.value && !m.isSearchAction)
                    .map(m => `${m.role}: ${m.content}`)
                    .join('\n');
                
                const summaryText = await callLLM("你是会议书记员，客观、精准。", `请总结本轮对话：\n${roundLog}`);
                
                addMessage('书记员', summaryText);
                summaries.value.push({ round: currentRound.value, content: summaryText, time: new Date().toLocaleTimeString() });
                
                isAiTyping.value = false;
                currentRound.value++;
                speakerIndex.value = 0;
                
                setTimeout(() => {
                    addMessage('主持人', `第 ${currentRound.value} 轮讨论开始，请继续。`, true);
                    processTurn();
                }, 1000);
            };

            const endMeeting = async () => {
                if (status.value === 'finished') return;
                paused.value = true;
                status.value = 'finished';
                clearInterval(timerInterval);
                if (turnTimer) clearTimeout(turnTimer);

                isAiTyping.value = true;
                addMessage('主持人', '会议结束，正在生成纪要...', true);

                const allSummaries = summaries.value.map(s => `R${s.round}: ${s.content}`).join('\n');
                const report = await callLLM("你是会议秘书。", `根据历次小结生成Markdown纪要：\n${allSummaries}`);
                
                finalReport.value = report;
                isAiTyping.value = false;
            };

            // --- LLM 调用 ---
            const callLLM = async (system, user) => {
                if (!apiConfig.apiKey) return await mockLLMResponse(system, user);
                
                try {
                    const res = await fetch(`${apiConfig.baseUrl || 'https://api.openai.com/v1'}/chat/completions`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiConfig.apiKey}` },
                        body: JSON.stringify({
                            model: apiConfig.model,
                            messages: [{ role: 'system', content: system }, { role: 'user', content: user }],
                            temperature: 0.7
                        })
                    });
                    const data = await res.json();
                    return data.choices[0].message.content;
                } catch (e) {
                    return `[API Error]: ${e.message}`;
                }
            };

            // 核心修复：Mock 逻辑必须能识别插话
            const mockLLMResponse = (system, user) => {
                return new Promise(resolve => {
                    setTimeout(() => {
                        // 1. 优先检测插话指令
                        if (user.includes("HIGHEST PRIORITY") || (user.includes("主持人") && user.includes("插话"))) {
                            const responses = [
                                "好的主持人，收到您的指示。针对您刚才提出的点，我认为...",
                                "收到，我们立即调整讨论方向。关于您说的问题...",
                                "非常好的切入点，主持人。确实我们忽略了这个方面..."
                            ];
                            resolve(responses[Math.floor(Math.random() * responses.length)]);
                            return;
                        }

                        // 2. 正常逻辑
                        if (system.includes("书记员")) {
                            resolve(`**本轮小结**：\n- 讨论了方案的可行性。\n- **共识**：方向正确。\n- **冲突**：预算不足。`);
                        } else if (user.includes("生成Markdown纪要")) {
                            resolve(`# 会议纪要\n\n## 1. 摘要\n本次会议卓有成效。\n\n## 2. 结论\n通过方案 A。\n\n## 3. 待办\n- CTO: 执行部署`);
                        } else {
                            const responses = [
                                "我认为风险控制是第一位的。", 
                                "这个提议很有建设性，但我担心执行难度。",
                                "从数据上看，我们需要更激进一点。", 
                                settings.webSearch ? "我搜索了最新的市场动态，竞争对手已经开始行动了。" : "基于过往经验，我建议稳扎稳打。"
                            ];
                            resolve(responses[Math.floor(Math.random() * responses.length)]);
                        }
                    }, 1000);
                });
            };

            // --- 辅助 ---
            const addMessage = (role, content, isHost = false) => {
                messages.value.push({
                    role, content, time: new Date().toLocaleTimeString(),
                    isIntervention: false, isSearchAction: false, round: currentRound.value
                });
                scrollToBottom();
            };
            
            const scrollToBottom = () => nextTick(() => {
                const c = document.getElementById('chat-container');
                c.scrollTop = c.scrollHeight;
            });

            const submitHumanInput = () => {
                if (!humanInput.value.trim()) return;
                addMessage(currentSpeakerName.value, humanInput.value);
                humanInput.value = '';
                nextTurn();
            };

            const handleFileUpload = async (e) => {
                for (let file of e.target.files) {
                    backgroundFiles.value.push({ name: file.name, content: await file.text() });
                }
            };
            const removeFile = (i) => backgroundFiles.value.splice(i, 1);
            const addParticipant = () => customParticipants.value.push({ name: '新角色', type: 'ai', prompt: '' });
            const removeParticipant = (i) => customParticipants.value.splice(i, 1);
            const togglePause = () => {
                paused.value = !paused.value;
                if (!paused.value && status.value === 'running' && !waitingForHuman.value) processTurn();
            };
            const formatTime = (s) => `${Math.floor(s/60).toString().padStart(2,'0')}:${(s%60).toString().padStart(2,'0')}`;
            const renderMarkdown = (t) => marked.parse(t);
            const exportReport = () => {
                const url = URL.createObjectURL(new Blob([finalReport.value], {type: 'text/markdown'}));
                const a = document.createElement('a'); a.href = url; a.download = 'Meeting_Report.md'; a.click();
            };

            return {
                showSettings, status, paused, topic, apiConfig, settings,
                customParticipants, messages, summaries, backgroundFiles,
                currentRound, timeLeft, isAiTyping, humanInput, interventionText, finalReport,
                statusText, statusColor, currentSpeakerName, waitingForHuman,
                startMeeting, endMeeting, togglePause, handleFileUpload, removeFile,
                addParticipant, removeParticipant, submitHumanInput, triggerIntervention,
                formatTime, renderMarkdown, exportReport
            };
        }
    }).mount('#app');
</script>
</body>
</html>