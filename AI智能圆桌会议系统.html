<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI 智能圆桌会议 (人才市场+云存档版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        /* 基础体验优化 */
        body { -webkit-tap-highlight-color: transparent; }
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        
        /* 动画定义 */
        .clerk-bubble { border: 2px solid #8b5cf6; background-color: #f5f3ff; }
        .typing-dot { animation: typing 1.4s infinite ease-in-out both; }
        @keyframes typing { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
        
        .fade-enter-active, .fade-leave-active { transition: opacity 0.2s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        
        .scale-enter-active, .scale-leave-active { transition: transform 0.2s ease, opacity 0.2s ease; }
        .scale-enter-from, .scale-leave-to { transform: scale(0.95); opacity: 0; }

        /* 特殊状态 */
        .intervention-highlight { animation: flash 1s; }
        @keyframes flash { 0% { background-color: #fee2e2; } 100% { background-color: #fff1f2; } }
        .mobile-height { height: 100dvh; } /* 解决移动端地址栏遮挡 */
    </style>
</head>
<body class="bg-gray-100 mobile-height overflow-hidden text-sm font-sans text-gray-700">

<div id="app" class="flex flex-col md:flex-row h-full w-full max-w-[1920px] mx-auto relative">

    <transition name="fade">
        <div v-if="showSettings" class="fixed inset-0 bg-black/50 z-[70] flex items-center justify-center p-4">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-5 space-y-4 animate-scale">
                <div class="flex justify-between items-center border-b pb-3">
                    <h3 class="font-bold text-gray-800 text-lg"><i class="fa-solid fa-cog mr-2 text-blue-600"></i>系统设置</h3>
                    <button @click="showSettings = false" class="w-8 h-8 rounded-full hover:bg-gray-100 flex items-center justify-center text-gray-400"><i class="fa-solid fa-times"></i></button>
                </div>
                
                <div class="space-y-4 overflow-y-auto max-h-[60vh]">
                    <div class="space-y-2">
                        <h4 class="text-xs font-bold text-gray-400 uppercase tracking-wider">AI 模型配置</h4>
                        <input v-model="apiConfig.baseUrl" type="text" placeholder="Base URL (默认: openai.com)" class="w-full p-2.5 bg-gray-50 border rounded-lg text-xs focus:ring-2 ring-blue-500 outline-none transition">
                        <input v-model="apiConfig.apiKey" type="password" placeholder="API Key (留空则使用模拟演示)" class="w-full p-2.5 bg-gray-50 border rounded-lg text-xs focus:ring-2 ring-blue-500 outline-none transition">
                        <input v-model="apiConfig.model" type="text" placeholder="模型名称 (如: gpt-4)" class="w-full p-2.5 bg-gray-50 border rounded-lg text-xs focus:ring-2 ring-blue-500 outline-none transition">
                    </div>

                    <div class="space-y-2 pt-2 border-t border-dashed">
                        <h4 class="text-xs font-bold text-gray-400 uppercase tracking-wider flex items-center gap-1">
                            <i class="fa-solid fa-floppy-disk"></i> 数据存取 (跨设备)
                        </h4>
                        <div class="bg-blue-50 p-2 rounded text-[10px] text-blue-600 mb-2">
                            换浏览器或设备时，请先<b>导出</b>文件，再到新设备<b>导入</b>。
                        </div>
                        <div class="flex gap-2">
                            <button @click="exportData" class="flex-1 bg-white border border-gray-300 text-gray-700 py-2 rounded-lg text-xs font-bold hover:bg-gray-50 hover:text-blue-600 transition shadow-sm flex items-center justify-center gap-2">
                                <i class="fa-solid fa-download"></i> 导出配置
                            </button>
                            <label class="flex-1 bg-blue-600 text-white border border-blue-600 py-2 rounded-lg text-xs font-bold hover:bg-blue-700 transition shadow-sm text-center cursor-pointer flex items-center justify-center gap-2">
                                <i class="fa-solid fa-upload"></i> 导入配置
                                <input type="file" @change="importData" accept=".json" class="hidden">
                            </label>
                        </div>
                    </div>

                    <div class="flex items-center justify-between pt-2 border-t border-dashed">
                         <label class="text-xs font-bold text-gray-600">会议时长 (分钟)</label>
                         <input v-model.number="settings.duration" type="number" class="w-16 p-1 border rounded text-center text-xs">
                    </div>
                    <div class="flex items-center justify-between">
                        <label class="text-xs font-bold text-gray-600 flex items-center gap-1">
                            <i class="fa-solid fa-globe text-blue-500"></i> 允许联网搜索
                        </label>
                        <input type="checkbox" v-model="settings.webSearch" class="accent-blue-600 w-4 h-4">
                    </div>
                </div>

                <button @click="showSettings = false" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2.5 rounded-lg text-sm font-bold shadow-md transition active:scale-95">完成设置</button>
            </div>
        </div>
    </transition>

    <transition name="scale">
        <div v-if="showTalentMarket" class="fixed inset-0 bg-gray-100 z-[60] flex flex-col p-2 md:p-8">
            <div class="bg-white rounded-2xl shadow-xl flex flex-col h-full max-w-6xl mx-auto w-full overflow-hidden border border-gray-200">
                <div class="p-4 border-b flex justify-between items-center bg-slate-50 shrink-0">
                    <div>
                        <h2 class="text-lg font-bold text-gray-800 flex items-center gap-2">
                            <span class="w-8 h-8 rounded-lg bg-indigo-600 text-white flex items-center justify-center"><i class="fa-solid fa-store"></i></span>
                            人才市场
                        </h2>
                        <p class="text-xs text-gray-500 mt-0.5 ml-1">管理预设角色库，点击“聘用”快速加入会议。</p>
                    </div>
                    <button @click="showTalentMarket = false" class="w-8 h-8 rounded-full bg-white border hover:bg-gray-100 text-gray-500 transition"><i class="fa-solid fa-times"></i></button>
                </div>

                <div class="flex-1 flex flex-col md:flex-row overflow-hidden relative">
                    
                    <div class="flex-1 overflow-y-auto p-4 bg-gray-50">
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3">
                            <div @click="prepareEdit(null)" class="border-2 border-dashed border-gray-300 rounded-xl p-4 flex flex-col items-center justify-center cursor-pointer hover:border-indigo-500 hover:bg-indigo-50 transition min-h-[140px] group bg-white">
                                <div class="w-12 h-12 rounded-full bg-gray-100 group-hover:bg-indigo-100 flex items-center justify-center text-gray-400 group-hover:text-indigo-600 mb-2 transition">
                                    <i class="fa-solid fa-plus text-xl"></i>
                                </div>
                                <span class="text-xs font-bold text-gray-500 group-hover:text-indigo-600">新建角色模板</span>
                            </div>

                            <div v-for="t in talentPool" :key="t.id" class="bg-white border border-gray-200 rounded-xl p-3 shadow-sm hover:shadow-md transition flex flex-col relative group hover:border-indigo-300">
                                <div class="flex justify-between items-start mb-2">
                                    <div class="flex items-center gap-2">
                                        <div class="w-8 h-8 rounded-full bg-indigo-100 text-indigo-600 flex items-center justify-center font-bold text-xs">{{ t.name.charAt(0) }}</div>
                                        <div class="font-bold text-sm text-gray-800 truncate max-w-[100px]">{{ t.name }}</div>
                                    </div>
                                    <div class="flex gap-1 opacity-100 md:opacity-0 group-hover:opacity-100 transition-opacity">
                                        <button @click.stop="prepareEdit(t)" class="w-6 h-6 flex items-center justify-center rounded hover:bg-blue-50 text-gray-400 hover:text-blue-500 transition" title="编辑"><i class="fa-solid fa-pen text-xs"></i></button>
                                        <button @click.stop="deleteTalent(t.id)" class="w-6 h-6 flex items-center justify-center rounded hover:bg-red-50 text-gray-400 hover:text-red-500 transition" title="删除"><i class="fa-solid fa-trash text-xs"></i></button>
                                    </div>
                                </div>
                                <div class="bg-gray-50 p-2 rounded text-[10px] text-gray-500 mb-3 flex-1 overflow-hidden h-16 leading-relaxed border border-gray-100">
                                    {{ t.prompt }}
                                </div>
                                <button @click="recruitTalent(t)" class="w-full bg-white border border-indigo-200 text-indigo-600 hover:bg-indigo-600 hover:text-white hover:border-indigo-600 py-2 rounded-lg text-xs font-bold flex items-center justify-center gap-2 transition active:scale-95">
                                    <i class="fa-solid fa-user-plus"></i> 聘用参会
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="w-full md:w-80 bg-white border-l border-gray-200 flex flex-col shadow-[0_0_15px_rgba(0,0,0,0.1)] z-10 transition-transform duration-300 absolute inset-0 md:static transform" 
                         :class="isEditing ? 'translate-x-0' : 'translate-x-full md:translate-x-0 md:block md:w-80' + (!isEditing ? ' md:hidden' : '')">
                         
                         <div class="p-4 border-b flex justify-between items-center bg-gray-50">
                            <h3 class="font-bold text-sm text-gray-700">{{ editForm.id ? '编辑角色' : '新建角色' }}</h3>
                            <button @click="cancelEdit" class="text-gray-500 hover:text-gray-800 text-xs">取消/关闭</button>
                        </div>
                        
                        <div class="p-4 space-y-4 flex-1 overflow-y-auto">
                            <div>
                                <label class="block text-xs font-bold text-gray-500 mb-1">角色头衔/名称</label>
                                <input v-model="editForm.name" type="text" placeholder="例如：法务顾问" class="w-full border border-gray-300 rounded-lg p-2.5 text-sm focus:ring-2 ring-indigo-500 outline-none transition">
                            </div>
                            <div class="flex-1 flex flex-col h-full">
                                <label class="block text-xs font-bold text-gray-500 mb-1">人设 Prompt (指令)</label>
                                <textarea v-model="editForm.prompt" placeholder="描述该角色的性格、职责、说话风格..." class="w-full border border-gray-300 rounded-lg p-2.5 text-sm focus:ring-2 ring-indigo-500 outline-none flex-1 resize-none min-h-[150px] transition"></textarea>
                                <p class="text-[10px] text-gray-400 mt-1">提示：越具体，AI 扮演得越像。</p>
                            </div>
                        </div>
                        
                        <div class="p-4 border-t bg-gray-50">
                            <button @click="saveTalent" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-2.5 rounded-lg text-xs font-bold shadow-md transition active:scale-95 flex items-center justify-center gap-2">
                                <i class="fa-solid fa-save"></i> {{ editForm.id ? '保存修改' : '创建新角色' }}
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </transition>

    <aside class="flex-col bg-white border-r border-gray-200 h-full w-full md:w-1/4 md:flex shadow-sm z-20"
           :class="activeTab === 'setup' ? 'flex' : 'hidden'">
        
        <div class="p-4 border-b border-gray-100 flex justify-between items-center bg-gray-50 sticky top-0 z-10">
            <h1 class="text-lg font-bold text-gray-800"><i class="fa-solid fa-users-rectangle mr-2 text-blue-600"></i>圆桌会议</h1>
            <button @click="showSettings = true" class="w-8 h-8 rounded-full bg-white border hover:bg-blue-50 text-gray-600 hover:text-blue-600 transition shadow-sm" title="系统设置">
                <i class="fa-solid fa-gear"></i>
            </button>
        </div>

        <div class="flex-1 overflow-y-auto p-4 space-y-6 pb-20 md:pb-4">
            <section>
                <h2 class="text-xs font-bold text-gray-400 uppercase mb-2 tracking-wider">核心议题</h2>
                <textarea v-model="topic" placeholder="输入本次会议讨论的主题..." class="w-full p-3 border rounded-xl h-20 text-sm mb-2 focus:ring-2 ring-blue-500 outline-none resize-none bg-gray-50 focus:bg-white transition"></textarea>
                
                <div class="relative border-2 border-dashed border-gray-300 rounded-xl p-3 text-center hover:bg-blue-50 hover:border-blue-300 transition cursor-pointer group bg-gray-50">
                    <input type="file" @change="handleFileUpload" class="absolute inset-0 opacity-0 cursor-pointer" multiple accept=".txt,.md,.json">
                    <div class="text-gray-500 group-hover:text-blue-600 transition flex items-center justify-center gap-2">
                        <i class="fa-solid fa-cloud-upload-alt"></i>
                        <span class="text-xs font-bold">上传背景材料</span>
                    </div>
                </div>
                
                <div class="mt-2 space-y-1">
                    <div v-for="(file, idx) in backgroundFiles" :key="idx" class="flex justify-between items-center text-xs bg-blue-50 text-blue-700 p-2 rounded-lg border border-blue-100 animate-fade-in">
                        <span class="truncate flex-1 mr-2"><i class="fa-regular fa-file-lines mr-1"></i>{{ file.name }}</span>
                        <button @click="removeFile(idx)" class="w-5 h-5 flex items-center justify-center rounded hover:bg-red-100 text-red-400 hover:text-red-600">&times;</button>
                    </div>
                </div>
            </section>

            <section>
                <div class="flex justify-between items-center mb-2">
                    <h2 class="text-xs font-bold text-gray-400 uppercase tracking-wider">参会人员</h2>
                    <div class="flex gap-2">
                        <button @click="showTalentMarket = true" class="bg-indigo-50 text-indigo-600 border border-indigo-200 hover:bg-indigo-100 px-2 py-1 rounded text-xs font-bold transition flex items-center gap-1">
                            <i class="fa-solid fa-store"></i> 人才库
                        </button>
                        <button @click="addParticipant" class="bg-gray-100 hover:bg-gray-200 text-gray-600 px-2 py-1 rounded text-xs font-bold transition">
                            <i class="fa-solid fa-plus"></i>
                        </button>
                    </div>
                </div>
                
                <div class="space-y-2">
                    <div class="p-2 bg-yellow-50 border border-yellow-200 rounded-lg flex justify-between items-center">
                        <span class="font-bold text-xs text-yellow-800"><i class="fa-solid fa-microphone mr-1"></i>主持人</span> 
                        <span class="text-[10px] bg-yellow-200 px-1.5 rounded text-yellow-800">控场</span>
                    </div>
                    <div class="p-2 bg-purple-50 border border-purple-200 rounded-lg flex justify-between items-center">
                        <span class="font-bold text-xs text-purple-800"><i class="fa-solid fa-pen-nib mr-1"></i>书记员</span> 
                        <span class="text-[10px] bg-purple-200 px-1.5 rounded text-purple-800">记录</span>
                    </div>

                    <transition-group name="fade">
                        <div v-for="(p, index) in customParticipants" :key="index" class="p-3 border border-gray-200 rounded-xl relative group bg-white shadow-sm hover:shadow-md transition">
                            <button @click="removeParticipant(index)" class="absolute top-2 right-2 text-gray-300 hover:text-red-500 w-6 h-6 flex items-center justify-center transition">
                                <i class="fa-solid fa-trash-can"></i>
                            </button>
                            <div class="flex items-center gap-2 mb-2 pr-6">
                                <div class="w-6 h-6 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 text-xs font-bold shrink-0">
                                    {{ p.name.charAt(0) }}
                                </div>
                                <input v-model="p.name" class="font-bold text-sm border-b border-transparent hover:border-gray-300 focus:border-blue-500 w-full outline-none bg-transparent transition" placeholder="角色名称">
                            </div>
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-[10px] text-gray-400 font-bold uppercase">控制模式</span>
                                <select v-model="p.type" class="text-[10px] border rounded bg-gray-50 px-2 py-0.5 outline-none">
                                    <option value="ai">AI 托管</option>
                                    <option value="human">人工扮演</option>
                                </select>
                            </div>
                            <textarea v-model="p.prompt" class="w-full text-xs text-gray-600 border border-gray-200 p-2 rounded-lg h-12 resize-none bg-gray-50 focus:bg-white focus:ring-1 ring-blue-300 outline-none transition" placeholder="设定人设..."></textarea>
                        </div>
                    </transition-group>
                </div>
            </section>
        </div>
    </aside>

    <main class="flex-col bg-slate-50 relative h-full w-full md:w-1/2 md:flex"
          :class="activeTab === 'chat' ? 'flex' : 'hidden'">
          
        <header class="h-14 border-b flex items-center justify-between px-4 bg-white shadow-sm z-10 shrink-0">
            <div class="flex items-center gap-2 overflow-hidden">
                <span class="px-2.5 py-1 rounded-full text-[10px] font-bold tracking-wide shadow-sm whitespace-nowrap" :class="statusColor">
                    {{ statusText }}
                </span>
                <span class="text-xs text-gray-500 border-l pl-2 truncate">第 <span class="font-bold text-gray-800">{{ currentRound }}</span> 轮</span>
                <span v-if="settings.webSearch" class="hidden sm:inline-block text-[10px] text-blue-600 bg-blue-50 px-1.5 py-0.5 rounded border border-blue-100">
                    <i class="fa-solid fa-globe"></i> Web
                </span>
            </div>
            <div class="font-mono text-lg font-bold text-gray-700 tabular-nums" :class="{'text-red-500': timeLeft < 60}">
                {{ formatTime(timeLeft) }}
            </div>
        </header>

        <div id="chat-container" class="flex-1 overflow-y-auto p-4 space-y-6 pb-20 md:pb-6 scroll-smooth">
            <div v-if="messages.length === 0" class="flex flex-col items-center justify-center h-full text-gray-400 animate-fade-in">
                <div class="w-20 h-20 bg-white rounded-full flex items-center justify-center mb-4 shadow-sm">
                    <i class="fa-solid fa-comments text-4xl text-gray-200"></i>
                </div>
                <p class="text-sm font-medium text-gray-500">会议准备就绪</p>
                <button v-if="status === 'setup'" @click="startMeeting" class="mt-6 md:hidden bg-blue-600 text-white px-8 py-2 rounded-full shadow-lg text-sm font-bold animate-pulse">
                    立即开始
                </button>
            </div>

            <div v-for="(msg, index) in messages" :key="index" class="flex flex-col group animate-fade-in">
                <div v-if="msg.role === '书记员'" class="mx-auto w-[95%] md:w-4/5 clerk-bubble rounded-xl p-4 shadow-sm relative overflow-hidden my-2">
                    <div class="absolute top-0 left-0 w-1 h-full bg-purple-500"></div>
                    <div class="flex items-center gap-2 mb-2 text-purple-700 font-bold border-b border-purple-200 pb-2">
                        <i class="fa-solid fa-scroll"></i>
                        <span class="text-xs">{{ msg.role }}</span>
                        <span class="text-[10px] font-normal ml-auto text-purple-400 opacity-70">{{ msg.time }}</span>
                    </div>
                    <div class="prose prose-sm prose-purple max-w-none text-xs leading-relaxed break-words" v-html="renderMarkdown(msg.content)"></div>
                </div>

                <div v-else-if="msg.isSearchAction" class="flex items-center gap-2 text-xs text-blue-500 ml-4 mb-2 italic opacity-80 bg-blue-50 self-start px-3 py-1 rounded-full">
                    <i class="fa-solid fa-search fa-spin"></i> {{ msg.role }} 正在检索数据...
                </div>

                <div v-else class="flex flex-col gap-1 max-w-[90%] md:max-w-[85%]" :class="msg.role.includes('主持人') ? 'self-center w-full md:w-3/4' : 'self-start'">
                    <div class="flex items-center gap-2 text-[10px] text-gray-500 px-1" :class="{'justify-center': msg.role.includes('主持人')}">
                        <span class="font-bold text-gray-700">{{ msg.role }}</span>
                        <span>{{ msg.time }}</span>
                    </div>
                    <div class="p-3.5 rounded-2xl shadow-sm text-gray-800 text-sm leading-relaxed border relative transition-all duration-300 break-words" 
                         :class="[
                            msg.role.includes('主持人') ? 'bg-orange-50 border-orange-200 rounded-tr-none text-center' : 'bg-white border-gray-100 rounded-tl-none',
                            msg.isIntervention ? 'ring-2 ring-red-400 border-red-400 bg-red-50 intervention-highlight' : ''
                         ]">
                         <div v-if="msg.isIntervention" class="absolute -top-2 -right-2 bg-red-500 text-white text-[10px] px-2 py-0.5 rounded-full shadow font-bold z-10">
                             <i class="fa-solid fa-bolt mr-1"></i>强制插话
                         </div>
                        <div class="prose prose-sm max-w-none" v-html="renderMarkdown(msg.content)"></div>
                    </div>
                </div>
            </div>

            <div v-if="isAiTyping" class="flex items-center gap-2 text-gray-400 text-xs ml-4 pb-2">
                <span class="font-bold text-gray-600">{{ currentSpeakerName }}</span>
                <div class="flex gap-1 ml-1 items-center h-4">
                    <div class="w-1.5 h-1.5 bg-gray-400 rounded-full typing-dot" style="animation-delay: 0s"></div>
                    <div class="w-1.5 h-1.5 bg-gray-400 rounded-full typing-dot" style="animation-delay: 0.2s"></div>
                    <div class="w-1.5 h-1.5 bg-gray-400 rounded-full typing-dot" style="animation-delay: 0.4s"></div>
                </div>
            </div>
        </div>

        <footer class="p-3 md:p-4 border-t bg-white z-20 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)] shrink-0 pb-20 md:pb-4">
            <div v-if="status === 'setup' || status === 'finished'" class="flex justify-center">
                <button @click="startMeeting" class="w-full md:w-auto bg-blue-600 hover:bg-blue-700 text-white px-8 py-3 rounded-xl md:rounded-full shadow-lg hover:shadow-xl transition flex items-center justify-center gap-2 text-sm font-bold active:scale-95">
                    <i class="fa-solid fa-play"></i> {{ status === 'setup' ? '启动圆桌会议' : '开启新会议' }}
                </button>
            </div>

            <div v-else class="flex flex-col gap-3">
                <div v-if="waitingForHuman" class="flex gap-2 animate-pulse bg-green-50 p-2 rounded-xl border border-green-200 items-center shadow-inner">
                    <span class="text-xs font-bold text-green-700 px-2 py-1 bg-green-200 rounded whitespace-nowrap">轮到你</span>
                    <input v-model="humanInput" @keyup.enter="submitHumanInput" type="text" class="flex-1 text-sm bg-transparent outline-none text-gray-800 placeholder-green-700/40" placeholder="请输入您的观点...">
                    <button @click="submitHumanInput" class="w-8 h-8 flex items-center justify-center bg-green-600 text-white rounded-lg shadow"><i class="fa-solid fa-paper-plane text-xs"></i></button>
                </div>

                <div v-else class="flex gap-2 items-center">
                     <div class="relative flex-1">
                        <i class="fa-solid fa-bolt absolute left-3 top-3 text-gray-400 text-xs"></i>
                        <input v-model="interventionText" @keyup.enter="triggerIntervention" type="text" class="w-full border border-gray-200 rounded-full pl-8 pr-4 py-2.5 text-sm focus:ring-2 ring-red-200 outline-none bg-gray-50 focus:bg-white transition" placeholder="强制插话 (AI将停止并回应)...">
                     </div>
                     <button @click="triggerIntervention" class="bg-white hover:bg-red-50 text-red-500 border border-red-200 px-4 py-2.5 rounded-full text-sm font-bold whitespace-nowrap transition shadow-sm active:scale-95">
                         插话
                     </button>
                </div>

                <div class="flex justify-between items-center border-t pt-2 border-gray-100">
                    <div class="flex gap-2">
                        <button @click="togglePause" class="flex-1 md:flex-none text-gray-600 hover:text-blue-600 text-xs bg-gray-100 hover:bg-blue-50 px-3 py-1.5 rounded-lg transition flex items-center justify-center gap-2">
                            <i class="fa-solid" :class="paused ? 'fa-play' : 'fa-pause'"></i> 
                            {{ paused ? '继续' : '暂停' }}
                        </button>
                        <button @click="endMeeting" class="flex-1 md:flex-none text-gray-500 hover:text-red-600 text-xs hover:bg-red-50 px-3 py-1.5 rounded-lg transition flex items-center justify-center gap-2">
                            <i class="fa-solid fa-stop"></i> 结束
                        </button>
                    </div>
                    <div class="text-[10px] text-gray-400 flex items-center gap-2 hidden sm:flex">
                        <span v-if="!paused" class="flex h-2 w-2 relative">
                          <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                          <span class="relative inline-flex rounded-full h-2 w-2 bg-green-500"></span>
                        </span>
                        当前发言: {{ currentSpeakerName || '...' }}
                    </div>
                </div>
            </div>
        </footer>
    </main>

    <aside class="flex-col bg-white border-l border-gray-200 h-full w-full md:w-1/4 md:flex shadow-sm z-20"
           :class="activeTab === 'board' ? 'flex' : 'hidden'">
        
        <div class="p-4 border-b bg-gray-50 flex items-center justify-between sticky top-0 z-10">
            <h3 class="font-bold text-gray-700 text-xs uppercase tracking-wider"><i class="fa-solid fa-clipboard-list mr-2 text-purple-600"></i>实时白板</h3>
            <span class="text-[10px] text-gray-400 bg-white px-2 py-0.5 rounded border">Sync</span>
        </div>
        
        <div class="flex-1 overflow-y-auto p-4 space-y-4 bg-white pb-20 md:pb-4">
            <div v-if="finalReport" class="p-4 bg-green-50 border border-green-200 rounded-xl shadow-sm animate-fade-in relative">
                <div class="absolute -top-2.5 left-4 bg-green-600 text-white text-[10px] px-2 py-0.5 rounded shadow-sm font-bold tracking-wide">
                    FINAL REPORT
                </div>
                <h4 class="font-bold text-green-800 text-sm mb-3 mt-2 border-b border-green-200 pb-2">会议最终纪要</h4>
                <div class="prose prose-xs prose-green max-w-none break-words" v-html="renderMarkdown(finalReport)"></div>
                <div class="mt-4 pt-2 border-t border-green-200 text-center">
                    <button @click="exportReport" class="w-full text-xs bg-white border border-green-300 text-green-700 px-3 py-2 rounded-lg hover:bg-green-600 hover:text-white transition flex items-center justify-center gap-2 font-bold">
                        <i class="fa-solid fa-download"></i> 导出 Markdown
                    </button>
                </div>
            </div>

            <div v-for="(summary, idx) in summaries" :key="idx" class="p-3 bg-gray-50 border border-gray-200 rounded-xl text-xs hover:border-purple-300 transition group animate-fade-in">
                <div class="flex justify-between text-gray-400 mb-2 pb-1 border-b border-gray-100">
                    <span class="font-bold text-gray-600 group-hover:text-purple-600 transition">第 {{ summary.round }} 轮小结</span>
                    <span>{{ summary.time }}</span>
                </div>
                <div class="prose prose-xs text-gray-600 break-words" v-html="renderMarkdown(summary.content)"></div>
            </div>

            <div v-if="summaries.length === 0 && !finalReport" class="flex flex-col items-center justify-center h-64 opacity-40">
                <i class="fa-regular fa-clipboard text-5xl text-gray-300 mb-3"></i>
                <p class="text-xs text-gray-400 text-center">暂无记录<br>等待书记员产出...</p>
            </div>
        </div>
    </aside>

    <nav class="md:hidden fixed bottom-0 w-full bg-white border-t border-gray-200 flex justify-around items-center h-16 z-50 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)] pb-safe">
        <button @click="activeTab = 'setup'" class="flex flex-col items-center gap-1 w-1/3 py-2 transition" :class="activeTab === 'setup' ? 'text-blue-600' : 'text-gray-400'">
            <i class="fa-solid fa-sliders text-xl"></i>
            <span class="text-[10px] font-bold">配置</span>
        </button>
        <button @click="activeTab = 'chat'" class="flex flex-col items-center gap-1 w-1/3 py-2 transition" :class="activeTab === 'chat' ? 'text-blue-600' : 'text-gray-400'">
            <div class="relative">
                <i class="fa-solid fa-comments text-xl"></i>
                <span v-if="status === 'running'" class="absolute -top-1 -right-1 w-2.5 h-2.5 bg-green-500 rounded-full border border-white animate-pulse"></span>
            </div>
            <span class="text-[10px] font-bold">会议</span>
        </button>
        <button @click="activeTab = 'board'" class="flex flex-col items-center gap-1 w-1/3 py-2 transition" :class="activeTab === 'board' ? 'text-blue-600' : 'text-gray-400'">
            <div class="relative">
                <i class="fa-solid fa-clipboard-list text-xl"></i>
                <span v-if="summaries.length > 0" class="absolute -top-1 -right-2 bg-red-500 text-white text-[9px] px-1 rounded-full">{{ summaries.length }}</span>
            </div>
            <span class="text-[10px] font-bold">白板</span>
        </button>
    </nav>

</div>

<script>
    const { createApp, ref, computed, reactive, nextTick, watch, onMounted } = Vue;

    createApp({
        setup() {
            // --- UI 状态 ---
            const showSettings = ref(false);
            const showTalentMarket = ref(false); // 控制人才市场显示
            const isEditing = ref(false); // 控制人才市场是否在编辑
            const activeTab = ref('setup');
            const status = ref('setup'); 
            const paused = ref(false);
            const topic = ref('如何利用生成式 AI 优化企业内部知识管理？');
            
            // --- 配置 ---
            const apiConfig = reactive({
                baseUrl: '',
                apiKey: '',
                model: 'gpt-3.5-turbo'
            });
            const settings = reactive({
                duration: 30, 
                webSearch: false
            });
            
            // --- 数据持久化与人才市场 ---
            const defaultTalents = [
                { id: 1, name: 'CTO', prompt: '你是一个务实的技术总监，关注数据安全、私有化部署成本，对云服务持谨慎态度。发言简练，喜欢用技术术语。' },
                { id: 2, name: '运营总监', prompt: '你关注效率提升和员工上手难度，希望工具越简单越好，不关心底层技术。喜欢举具体的业务场景例子。' },
                { id: 3, name: '财务顾问', prompt: '你非常关注ROI（投资回报率），任何支出都需要明确的收益预期，喜欢用数字说话，对预算非常敏感。' },
                { id: 4, name: '激进派PM', prompt: '你是年轻的产品经理，热衷于尝试最新的AI技术，认为不创新就是死亡，对新技术有盲目崇拜，经常用流行词汇。' },
                { id: 5, name: '法务', prompt: '你极度关注合规性、版权风险和数据隐私，是团队中的“刹车片”，说话严谨，喜欢引用法规风险。' }
            ];
            
            const talentPool = ref([]);
            const editForm = reactive({ id: null, name: '', prompt: '' });

            // 初始化：读取本地存储
            onMounted(() => {
                const savedTalents = localStorage.getItem('ai_meet_talents');
                if (savedTalents) {
                    try {
                        talentPool.value = JSON.parse(savedTalents);
                    } catch(e) {
                        talentPool.value = JSON.parse(JSON.stringify(defaultTalents));
                    }
                } else {
                    talentPool.value = JSON.parse(JSON.stringify(defaultTalents));
                }
                
                // 默认加两个
                if(customParticipants.value.length === 0 && talentPool.value.length >= 2) {
                     customParticipants.value.push({name: talentPool.value[0].name, type: 'ai', prompt: talentPool.value[0].prompt});
                     customParticipants.value.push({name: talentPool.value[1].name, type: 'ai', prompt: talentPool.value[1].prompt});
                }
            });

            const saveTalentPool = () => {
                localStorage.setItem('ai_meet_talents', JSON.stringify(talentPool.value));
            };

            // --- 人才市场操作 ---
            const prepareEdit = (talent) => {
                isEditing.value = true;
                if (talent) {
                    editForm.id = talent.id;
                    editForm.name = talent.name;
                    editForm.prompt = talent.prompt;
                } else {
                    editForm.id = null;
                    editForm.name = '';
                    editForm.prompt = '';
                }
            };
            const cancelEdit = () => { isEditing.value = false; editForm.id = null; };
            
            const saveTalent = () => {
                if (!editForm.name || !editForm.prompt) return alert('请填写完整信息');
                if (editForm.id) {
                    const idx = talentPool.value.findIndex(t => t.id === editForm.id);
                    if (idx !== -1) {
                        talentPool.value[idx].name = editForm.name;
                        talentPool.value[idx].prompt = editForm.prompt;
                    }
                } else {
                    const newId = Date.now();
                    talentPool.value.push({ id: newId, name: editForm.name, prompt: editForm.prompt });
                }
                saveTalentPool();
                cancelEdit();
            };
            
            const deleteTalent = (id) => {
                if (confirm('确定删除该角色模板吗？')) {
                    talentPool.value = talentPool.value.filter(t => t.id !== id);
                    saveTalentPool();
                }
            };

            const recruitTalent = (talent) => {
                customParticipants.value.push({
                    name: talent.name,
                    prompt: talent.prompt,
                    type: 'ai'
                });
                // 移动端体验优化：添加后自动关闭市场
                if (window.innerWidth < 768) showTalentMarket.value = false;
            };

            // --- 核心功能：数据导入导出 ---
            const exportData = () => {
                const backupData = {
                    version: '2.0',
                    timestamp: new Date().toISOString(),
                    talents: talentPool.value,
                    settings: settings,
                    // 不强制导出 API Key，保护隐私，但导出 BaseUrl
                    apiConfig: { baseUrl: apiConfig.baseUrl, model: apiConfig.model } 
                };
                const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `AI_Meeting_Backup_${new Date().toISOString().slice(0,10)}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            };

            const importData = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        if (data.talents && Array.isArray(data.talents)) {
                            talentPool.value = data.talents;
                            saveTalentPool();
                        }
                        if (data.settings) Object.assign(settings, data.settings);
                        if (data.apiConfig) Object.assign(apiConfig, data.apiConfig);
                        
                        alert(`导入成功！\n已恢复 ${data.talents ? data.talents.length : 0} 个角色模板。`);
                        showSettings.value = false;
                    } catch (err) {
                        alert("导入失败：文件格式不正确。");
                    }
                };
                reader.readAsText(file);
                event.target.value = ''; // 允许重复导入
            };

            // --- 运行时数据 ---
            const customParticipants = ref([]);
            const messages = ref([]);
            const summaries = ref([]);
            const backgroundFiles = ref([]);
            const currentRound = ref(1);
            const speakerIndex = ref(-1);
            const finalReport = ref(null);
            
            const isAiTyping = ref(false);
            const humanInput = ref('');
            const interventionText = ref('');
            const timeLeft = ref(settings.duration * 60);
            
            let timerInterval = null;
            let turnTimer = null; 

            // --- 计算属性 ---
            const allRoles = computed(() => customParticipants.value);

            const currentSpeakerName = computed(() => {
                if (status.value === 'setup') return '';
                if (status.value === 'finished') return '会议结束';
                if (speakerIndex.value === -1) return '主持人';
                if (speakerIndex.value === allRoles.value.length) return '书记员';
                return allRoles.value[speakerIndex.value]?.name || '未知';
            });

            const waitingForHuman = computed(() => {
                if (paused.value || status.value !== 'running') return false;
                if (speakerIndex.value >= 0 && speakerIndex.value < allRoles.value.length) {
                    return allRoles.value[speakerIndex.value].type === 'human';
                }
                return false;
            });

            const statusText = computed(() => {
                if (paused.value) return '暂停中';
                if (status.value === 'running') return '进行中';
                if (status.value === 'finished') return '已结束';
                return '设置中';
            });

            const statusColor = computed(() => {
                if (paused.value) return 'bg-yellow-100 text-yellow-700';
                if (status.value === 'running') return 'bg-green-100 text-green-700 animate-pulse';
                if (status.value === 'finished') return 'bg-gray-200 text-gray-700';
                return 'bg-blue-100 text-blue-700';
            });
            
            watch(status, (newVal) => {
                if (newVal === 'running') activeTab.value = 'chat';
            });

            // --- 方法 ---

            const startMeeting = () => {
                if (!topic.value.trim()) return alert("请输入会议议题");
                if (customParticipants.value.length === 0) return alert("请至少添加一名参会人员");
                
                showSettings.value = false;
                status.value = 'running';
                paused.value = false;
                timeLeft.value = settings.duration * 60;
                messages.value = [];
                summaries.value = [];
                finalReport.value = null;
                currentRound.value = 1;
                activeTab.value = 'chat';
                
                if (timerInterval) clearInterval(timerInterval);
                timerInterval = setInterval(() => {
                    if (!paused.value && status.value === 'running') {
                        timeLeft.value--;
                        if (timeLeft.value <= 0) endMeeting();
                    }
                }, 1000);

                addMessage('主持人', `各位好。本次会议议题为：**${topic.value}**。\n\n规则：请基于背景材料发言。${settings.webSearch ? '（注：系统已授权联网搜索权限，必要时可引用实时数据）' : ''}`, true);
                
                speakerIndex.value = 0;
                processTurn();
            };

            const processTurn = async () => {
                if (status.value !== 'running' || paused.value) return;

                const roles = allRoles.value;
                const idx = speakerIndex.value;

                if (idx >= roles.length) {
                    await performClerkSummary();
                    return;
                }

                const currentRole = roles[idx];
                
                if (currentRole.type === 'human') {
                    // 等待 UI
                } else {
                    isAiTyping.value = true;
                    scrollToBottom();
                    await generateAIResponse(currentRole);
                    isAiTyping.value = false;
                    nextTurn();
                }
            };

            const nextTurn = () => {
                if (status.value !== 'running') return;
                speakerIndex.value++;
                turnTimer = setTimeout(() => processTurn(), 800);
            };

            const generateAIResponse = async (role) => {
                const systemContext = `你正在参加圆桌会议。角色：${role.name}。人设：${role.prompt}。
                议题：${topic.value}。
                背景材料摘要：${backgroundFiles.value.map(f => f.content).join('\n').substring(0, 800)}...
                当前系统状态：[联网搜索: ${settings.webSearch ? 'ON' : 'OFF'}]`;
                
                const lastSummary = summaries.value.length > 0 ? summaries.value[summaries.value.length - 1].content : "无（首轮）";
                const currentRoundLog = messages.value
                    .filter(m => m.round === currentRound.value)
                    .map(m => `${m.role}: ${m.content}`)
                    .join('\n');

                const lastMsg = messages.value[messages.value.length - 1];
                const isIntervention = lastMsg && lastMsg.isIntervention;
                
                let instruction = `请以"${role.name}"身份发言。观点需简练、符合人设。`;
                let promptTail = "";
                
                if (isIntervention) {
                    promptTail = `\n\n!!! 紧急指令 (HIGHEST PRIORITY) !!!\n上一条消息是【主持人】的强制插话 (Intervention)。你必须 **无视所有轮次规则和话题惯性**。请直接、正面回答主持人的问题或执行指令。`;
                }

                const prompt = `[上一轮小结]: ${lastSummary}\n[本轮对话]: ${currentRoundLog}\n${instruction}\n${settings.webSearch && !isIntervention ? '如果需要最新数据，请模拟搜索动作。' : ''}${promptTail}`;

                if (settings.webSearch && Math.random() > 0.7 && !apiConfig.apiKey && !isIntervention) {
                    messages.value.push({
                        role: role.name, content: '', time: new Date().toLocaleTimeString(),
                        isSearchAction: true, round: currentRound.value
                    });
                    await new Promise(r => setTimeout(r, 1000));
                }

                const responseText = await callLLM(systemContext, prompt);
                addMessage(role.name, responseText);
            };

            const triggerIntervention = () => {
                if (!interventionText.value.trim()) return;
                
                messages.value.push({
                    role: '主持人 (插话)', 
                    content: interventionText.value,
                    time: new Date().toLocaleTimeString(), 
                    round: currentRound.value,
                    isIntervention: true
                });
                
                interventionText.value = '';
                scrollToBottom();

                if (!isAiTyping.value && status.value === 'running') {
                    if (turnTimer) clearTimeout(turnTimer); 
                    if (speakerIndex.value >= allRoles.value.length) {
                         speakerIndex.value = Math.max(0, allRoles.value.length - 1);
                    }
                    processTurn(); 
                }
            };

            const performClerkSummary = async () => {
                isAiTyping.value = true;
                const roundLog = messages.value
                    .filter(m => m.round === currentRound.value && !m.isSearchAction)
                    .map(m => `${m.role}: ${m.content}`)
                    .join('\n');
                
                const summaryText = await callLLM("你是会议书记员，客观、精准。", `请总结本轮对话：\n${roundLog}`);
                
                addMessage('书记员', summaryText);
                summaries.value.push({ round: currentRound.value, content: summaryText, time: new Date().toLocaleTimeString() });
                
                isAiTyping.value = false;
                currentRound.value++;
                speakerIndex.value = 0;
                
                setTimeout(() => {
                    addMessage('主持人', `第 ${currentRound.value} 轮讨论开始，请继续。`, true);
                    processTurn();
                }, 1000);
            };

            const endMeeting = async () => {
                if (status.value === 'finished') return;
                paused.value = true;
                status.value = 'finished';
                clearInterval(timerInterval);
                if (turnTimer) clearTimeout(turnTimer);

                isAiTyping.value = true;
                addMessage('主持人', '会议结束，正在生成纪要...', true);

                const allSummaries = summaries.value.map(s => `R${s.round}: ${s.content}`).join('\n');
                const report = await callLLM("你是会议秘书。", `根据历次小结生成Markdown纪要：\n${allSummaries}`);
                
                finalReport.value = report;
                isAiTyping.value = false;
                
                if(window.innerWidth < 768) {
                    setTimeout(() => alert("会议已结束，请前往【白板】查看最终纪要"), 500);
                }
            };

            // --- LLM 调用 ---
            const callLLM = async (system, user) => {
                if (!apiConfig.apiKey) return await mockLLMResponse(system, user);
                try {
                    const res = await fetch(`${apiConfig.baseUrl || 'https://api.openai.com/v1'}/chat/completions`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiConfig.apiKey}` },
                        body: JSON.stringify({
                            model: apiConfig.model,
                            messages: [{ role: 'system', content: system }, { role: 'user', content: user }],
                            temperature: 0.7
                        })
                    });
                    const data = await res.json();
                    return data.choices[0].message.content;
                } catch (e) {
                    return `[API Error]: ${e.message}`;
                }
            };

            const mockLLMResponse = (system, user) => {
                return new Promise(resolve => {
                    setTimeout(() => {
                        if (user.includes("HIGHEST PRIORITY")) {
                            resolve("收到主持人指示。我认为这是一个关键点，我们应该...");
                            return;
                        }
                        if (system.includes("书记员")) {
                            resolve(`**本轮小结**：\n- 讨论激烈。\n- 核心观点：AI 能显著提效。`);
                        } else if (user.includes("生成Markdown纪要")) {
                            resolve(`# 会议纪要\n\n本次会议圆满结束，达成多项共识。`);
                        } else {
                            const responses = [
                                "我认为风险控制是第一位的。", 
                                "从数据上看，我们需要更激进一点。", 
                                "如果不考虑成本，这确实是好主意。",
                                "我同意上一位的观点，补充一点..."
                            ];
                            resolve(responses[Math.floor(Math.random() * responses.length)]);
                        }
                    }, 1000);
                });
            };

            // --- 辅助 ---
            const addMessage = (role, content, isHost = false) => {
                messages.value.push({
                    role, content, time: new Date().toLocaleTimeString(),
                    isIntervention: false, isSearchAction: false, round: currentRound.value
                });
                scrollToBottom();
            };
            
            const scrollToBottom = () => nextTick(() => {
                const c = document.getElementById('chat-container');
                if(c) c.scrollTop = c.scrollHeight;
            });

            const submitHumanInput = () => {
                if (!humanInput.value.trim()) return;
                addMessage(currentSpeakerName.value, humanInput.value);
                humanInput.value = '';
                nextTurn();
            };

            const handleFileUpload = async (e) => {
                for (let file of e.target.files) {
                    backgroundFiles.value.push({ name: file.name, content: await file.text() });
                }
            };
            const removeFile = (i) => backgroundFiles.value.splice(i, 1);
            const addParticipant = () => customParticipants.value.push({ name: '新角色', type: 'ai', prompt: '' });
            const removeParticipant = (i) => customParticipants.value.splice(i, 1);
            const togglePause = () => {
                paused.value = !paused.value;
                if (!paused.value && status.value === 'running' && !waitingForHuman.value) processTurn();
            };
            const formatTime = (s) => `${Math.floor(s/60).toString().padStart(2,'0')}:${(s%60).toString().padStart(2,'0')}`;
            const renderMarkdown = (t) => marked.parse(t);
            const exportReport = () => {
                if(!finalReport.value) return;
                const url = URL.createObjectURL(new Blob([finalReport.value], {type: 'text/markdown'}));
                const a = document.createElement('a'); a.href = url; a.download = 'Meeting_Report.md'; a.click();
            };

            return {
                showSettings, showTalentMarket, isEditing, activeTab, status, paused, topic, 
                apiConfig, settings, talentPool, editForm,
                customParticipants, messages, summaries, backgroundFiles,
                currentRound, timeLeft, isAiTyping, humanInput, interventionText, finalReport,
                statusText, statusColor, currentSpeakerName, waitingForHuman,
                
                // 新增/修改的方法
                saveTalent, prepareEdit, cancelEdit, deleteTalent, recruitTalent,
                exportData, importData,
                
                startMeeting, endMeeting, togglePause, handleFileUpload, removeFile,
                addParticipant, removeParticipant, submitHumanInput, triggerIntervention,
                formatTime, renderMarkdown, exportReport
            };
        }
    }).mount('#app');
</script>
</body>
</html>