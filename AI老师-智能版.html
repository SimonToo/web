<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIè€å¸ˆ - è§†è§‰æ™ºèƒ½ç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 20px;
            margin: 0;
            background-color: #f4f4f4;
            color: #333;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
        }

        /* API è®¾ç½®åŒºåŸŸæ ·å¼ */
        .api-settings {
            background-color: #e8f5e9;
            padding: 15px;
            border-radius: 6px;
            border: 1px solid #c8e6c9;
            margin-bottom: 20px;
        }
        
        .api-settings h3 { margin-top: 0; color: #2e7d32; font-size: 1.1em; }

        .api-row { display: flex; gap: 10px; margin-bottom: 10px; flex-wrap: wrap; }
        .api-input { flex: 1; padding: 8px; border: 1px solid #ccc; border-radius: 4px; min-width: 200px; }

        .tips { font-size: 12px; color: #666; margin-top: 5px; line-height: 1.4; }

        select, input[type="text"], input[type="password"], input[type="number"], textarea {
            width: 100%; padding: 10px; margin: 10px 0; font-size: 16px;
            border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;
        }

        h1 { text-align: center; color: #333; margin-top: 20px; }
        h2 { color: #333; margin-top: 25px; font-size: 1.2em; border-left: 4px solid #4CAF50; padding-left: 10px; }

        textarea { resize: vertical; min-height: 120px; font-family: inherit; }

        .dynamic-display {
            margin: 10px 0; padding: 15px; background-color: #f8f9fa;
            border: 1px solid #e9ecef; border-radius: 4px; white-space: pre-wrap;
            font-family: monospace; font-size: 0.9em; color: #555;
            max-height: 200px; overflow-y: auto;
        }

        .ai-result-display {
            margin-top: 10px; padding: 20px; background-color: #fff;
            border: 2px solid #4CAF50; border-radius: 8px; min-height: 100px; line-height: 1.6;
        }

        .btn-group { display: flex; gap: 10px; margin-bottom: 30px; flex-wrap: wrap; }

        button {
            padding: 8px 15px; font-size: 14px; border: none; border-radius: 4px;
            cursor: pointer; transition: background-color 0.3s ease;
            display: flex; align-items: center; justify-content: center; gap: 5px;
        }

        .copy-button { background-color: #607d8b; color: white; }
        .copy-button:hover { background-color: #546e7a; }

        .run-ai-button { background-color: #4CAF50; color: white; }
        .run-ai-button:hover { background-color: #45a049; }
        .run-ai-button:disabled { background-color: #ccc; cursor: not-allowed; }

        .action-button { background-color: #2196F3; color: white; }
        .action-button:hover { background-color: #1e88e5; }
        
        .camera-btn { background-color: #FF9800; color: white; }
        .camera-btn:hover { background-color: #F57C00; }

        .loading-spinner {
            display: inline-block; width: 12px; height: 12px; border: 2px solid #fff;
            border-radius: 50%; border-top-color: transparent; animation: spin 1s linear infinite;
        }
        .loading-spinner-dark { border-color: #4CAF50; border-top-color: transparent; }
        @keyframes spin { to { transform: rotate(360deg); } }

        .tab-container { border-bottom: 2px solid #ddd; margin-bottom: 20px; }
        .tab-header { display: flex; justify-content: flex-start; background-color: #f4f4f4; padding: 0; overflow-x: auto;}
        .tab-header button {
            background-color: transparent; border: none; cursor: pointer; padding: 15px 25px; font-size: 16px; margin: 0;
            border-bottom: 3px solid transparent; transition: all 0.3s; white-space: nowrap; border-radius: 0;
        }
        .tab-header button:hover { background-color: #e0e0e0; }
        .tab-header button.active { background-color: #fff; border-bottom: 3px solid #4CAF50; color: #4CAF50; font-weight: bold; }
        .tab-content { display: none; padding: 20px 0; }
        .tab-content.active { display: block; }

        /* è§†è§‰è¯†åˆ«åŒºåŸŸæ ·å¼ */
        .vision-container {
            border: 2px dashed #ccc; padding: 15px; text-align: center;
            border-radius: 8px; margin-bottom: 20px; background: #fafafa;
            position: relative;
            min-height: 200px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        
        #preview-image {
            max-width: 100%; max-height: 400px; border-radius: 4px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1); margin-top: 10px; display: none;
        }

        #camera-stream {
            width: 100%; max-width: 500px; border-radius: 4px; display: none; background: #000;
        }

        .input-methods {
            display: flex; gap: 15px; justify-content: center; margin-bottom: 15px; width: 100%;
        }

        .input-option {
            padding: 10px 20px; border: 1px solid #ddd; border-radius: 20px; cursor: pointer; background: #fff;
        }
        .input-option.selected { border-color: #4CAF50; color: #4CAF50; font-weight: bold; background: #e8f5e9; }

        .ocr-status { font-weight: bold; margin: 10px 0; color: #555; }
        
        #canvas-capture { display: none; }

        @media screen and (max-width: 600px) {
            .container { margin: 10px; padding: 15px; }
            .api-row { flex-direction: column; gap: 5px; }
        }
    </style>
</head>
<body>
    <h1>AIè€å¸ˆ - è§†è§‰æ™ºèƒ½ç‰ˆ</h1>
    <div class="container">
        <div class="api-settings">
            <h3>âš™ï¸ API é…ç½® (å¿…é¡»ä½¿ç”¨æ”¯æŒVisionçš„æ¨¡å‹)</h3>
            <div class="api-row">
                <input type="text" id="api-url" class="api-input" placeholder="API Base URL (å¦‚ https://api.openai.com)" value="https://api.openai.com">
                <input type="password" id="api-key" class="api-input" placeholder="è¯·è¾“å…¥ API Key (sk-...)">
            </div>
            <div class="api-row">
                <input type="text" id="model-name" class="api-input" placeholder="æ¨¡å‹åç§° (å¦‚ gpt-4o, gpt-4-turbo)" value="gpt-4o">
            </div>
            <div class="tips">
                * <b>é‡è¦</b>ï¼šè¯·åŠ¡å¿…ä½¿ç”¨ <code>gpt-4o</code>, <code>gpt-4-turbo</code>, <code>claude-3-5-sonnet</code> ç­‰æ”¯æŒå›¾ç‰‡çš„æ¨¡å‹ã€‚<br>
                * æ™®é€šçš„ gpt-3.5 æˆ– deepseek-chat å¯èƒ½ä¸æ”¯æŒå›¾ç‰‡è¯†åˆ«ï¼Œä¼šå¯¼è‡´æŠ¥é”™ã€‚
            </div>
        </div>

        <div class="tab-container">
            <div class="tab-header">
                <button class="tab-btn active" onclick="switchTab(event, 'tab1')">å†™ä½œç­”é¢˜</button>
                <button class="tab-btn" onclick="switchTab(event, 'tab2')">è‹±æ±‰ç¿»è¯‘</button>
                <button class="tab-btn" onclick="switchTab(event, 'tab3')">AIè§†è§‰è¯†åˆ«</button>
            </div>

            <div id="tab1" class="tab-content active">
                <h2>è¯·é€‰æ‹©å¹´çº§</h2>
                <select name="grade" id="grade-select" onchange="updateDynamicText()">
                    <option value="" disabled selected></option>
                    <optgroup label="å°å­¦">
                        <option value="å°å­¦ä¸€å¹´çº§">å°å­¦ä¸€å¹´çº§</option>
                        <option value="å°å­¦äºŒå¹´çº§">å°å­¦äºŒå¹´çº§</option>
                        <option value="å°å­¦ä¸‰å¹´çº§">å°å­¦ä¸‰å¹´çº§</option>
                        <option value="å°å­¦å››å¹´çº§">å°å­¦å››å¹´çº§</option>
                        <option value="å°å­¦äº”å¹´çº§">å°å­¦äº”å¹´çº§</option>
                        <option value="å°å­¦å…­å¹´çº§">å°å­¦å…­å¹´çº§</option>
                    </optgroup>
                    <optgroup label="åˆä¸­">
                        <option value="åˆä¸­ä¸€å¹´çº§">åˆä¸­ä¸€å¹´çº§</option>
                        <option value="åˆä¸­äºŒå¹´çº§">åˆä¸­äºŒå¹´çº§</option>
                        <option value="åˆä¸­ä¸‰å¹´çº§">åˆä¸­ä¸‰å¹´çº§</option>
                    </optgroup>
                    <optgroup label="é«˜ä¸­">
                        <option value="é«˜ä¸­ä¸€å¹´çº§">é«˜ä¸­ä¸€å¹´çº§</option>
                        <option value="é«˜ä¸­äºŒå¹´çº§">é«˜ä¸­äºŒå¹´çº§</option>
                        <option value="é«˜ä¸­ä¸‰å¹´çº§">é«˜ä¸­ä¸‰å¹´çº§</option>
                    </optgroup>
                </select>

                <h2>è¯·é€‰æ‹©å­¦ç§‘</h2>
                <select name="subject" id="subject-select" onchange="updateDynamicText()">
                    <option value="" disabled selected></option>
                    <option value="è¯­æ–‡">è¯­æ–‡</option>
                    <option value="æ•°å­¦">æ•°å­¦</option>
                    <option value="è‹±è¯­">è‹±è¯­</option>
                </select>

                <h2>è¯·è¾“å…¥å­—æ•°</h2>
                <input type="number" name="number" id="number-input" placeholder="è¯·è¾“å…¥å­—æ•°" required onchange="updateDynamicText()">

                <h2>è¯·é€‰æ‹©æ–‡ä½“</h2>
                <select name="genre" id="genre-select" onchange="updateDynamicText()">
                    <option value="" disabled selected></option>
                    <optgroup label="çœ‹å›¾å†™è¯">
                        <option value="1">è®°äº‹ç±»çœ‹å›¾å†™è¯</option>
                        <option value="2">å†™æ™¯ç‰©ç±»çœ‹å›¾å†™è¯</option>
                        <option value="3">å†™äººç‰©ç±»çœ‹å›¾å†™è¯</option>
                        <option value="4">å†™çŠ¶ç‰©ç±»çœ‹å›¾å†™è¯</option>
                    </optgroup>
                    <optgroup label="å¸¸è§æ–‡ä½“">
                        <option value="5">ç•™è¨€æ¡</option>
                        <option value="6">æ—¥è®°</option>
                        <option value="7">å†™äººç‰©ç±»</option>
                        <option value="8">è®°äº‹ç±»</option>
                        <option value="9">å†™æ™¯ç‰©ç±»</option>
                        <option value="10">çŠ¶ç‰©ç±»</option>
                        <option value="11">ç«¥è¯ç±»</option>
                        <option value="12">æƒ³è±¡ç±»</option>
                    </optgroup>
                    <optgroup label="ä½œæ–‡ç±»å‹">
                        <option value="13">è¯´æ˜æ–‡</option>
                        <option value="14">å†™ä¿¡</option>
                        <option value="15">è¯»åæ„Ÿ</option>
                        <option value="16">å»ºè®®ä¹¦</option>
                        <option value="17">æ¼”è®²ç¨¿</option>
                        <option value="18">æ¼«ç”»ä½œæ–‡</option>
                        <option value="19">æ•…äº‹ç¼©å†™</option>
                        <option value="20">è¯—æ­Œ</option>
                    </optgroup>
                    <optgroup label="æ–‡å­¦ä½œå“">
                        <option value="21">ä½œå“æ¢—æ¦‚</option>
                        <option value="22">å°å°è¯´</option>
                        <option value="23">å†™äººè®°å™æ–‡</option>
                        <option value="24">å™äº‹è®°å™æ–‡</option>
                        <option value="25">å†™æ™¯è®°å™æ–‡</option>
                        <option value="26">çŠ¶ç‰©è®°å™æ–‡</option>
                        <option value="27">è®®è®ºæ–‡</option>
                    </optgroup>
                    <optgroup label="å®ç”¨æ–‡">
                        <option value="28">æ–°é—»(æ¶ˆæ¯)</option>
                        <option value="29">ä¼ è®°</option>
                        <option value="30">ä¹¦ä¿¡</option>
                        <option value="31">æ¸¸è®°</option>
                        <option value="32">ä½œå“ç¼©å†™</option>
                        <option value="33">æƒ³è±¡ä½œæ–‡</option>
                        <option value="34">å™äº‹æ•£æ–‡</option>
                        <option value="35">å…¶ä»–</option>
                    </optgroup>
                </select>

                <h2>å†™ä½œè¦æ±‚</h2>
                <textarea name="writing-requirements" id="writing-requirements" placeholder="è¯·è¾“å…¥å†™ä½œè¦æ±‚" onchange="updateDynamicText()"></textarea>

                <h2>ä½œæ–‡æ ‡é¢˜</h2>
                <input type="text" name="essay-title" id="essay-title" placeholder="è¯·è¾“å…¥ä½œæ–‡æ ‡é¢˜" onchange="updateDynamicText()">

                <h2>ä½œæ–‡æ­£æ–‡</h2>
                <textarea name="essay-content" id="essay-content" placeholder="è¯·è¾“å…¥ä½œæ–‡æ­£æ–‡" onchange="updateDynamicText()"></textarea>

                <h2>æ•°å­¦é—®é¢˜</h2>
                <textarea name="math-problem" id="math-problem" placeholder="è¯·è¾“å…¥æ•°å­¦é—®é¢˜" onchange="updateDynamicText()"></textarea>

                <h2>è‹±è¯­é—®é¢˜</h2>
                <textarea name="english-problem" id="english-problem" placeholder="è¯·è¾“å…¥è‹±è¯­é—®é¢˜" onchange="updateDynamicText()"></textarea>

                <h2>1. æ‰¹æ”¹ä½œæ–‡ã€åˆ†æè§£ç­”æ•°å­¦ã€è‹±è¯­é—®é¢˜</h2>
                <div id="dynamic-text" class="dynamic-display"></div>
                <div class="btn-group">
                    <button onclick="copyToClipboard('#dynamic-text')" class="copy-button">å¤åˆ¶æç¤ºè¯</button>
                    <button onclick="callAI('dynamic-text', 'result-1')" class="run-ai-button">ğŸ¤– AI ç”Ÿæˆç­”æ¡ˆ</button>
                </div>
                <div id="result-1" class="ai-result-display" style="display:none;"></div>

                <h2>2. æ ¹æ®è¦æ±‚å†™ä½œè¯­æ–‡ã€è‹±è¯­èŒƒæ–‡</h2>
                <div id="new-dynamic-text" class="dynamic-display"></div>
                <div class="btn-group">
                    <button onclick="copyToClipboard('#new-dynamic-text')" class="copy-button">å¤åˆ¶æç¤ºè¯</button>
                    <button onclick="callAI('new-dynamic-text', 'result-2')" class="run-ai-button">ğŸ¤– AI ç”Ÿæˆç­”æ¡ˆ</button>
                </div>
                <div id="result-2" class="ai-result-display" style="display:none;"></div>

                <h2>3. è¯­æ–‡ã€è‹±è¯­å†™ä½œå‡ºé¢˜</h2>
                <div id="third-dynamic-text" class="dynamic-display"></div>
                <div class="btn-group">
                    <button onclick="copyToClipboard('#third-dynamic-text')" class="copy-button">å¤åˆ¶æç¤ºè¯</button>
                    <button onclick="callAI('third-dynamic-text', 'result-3')" class="run-ai-button">ğŸ¤– AI ç”Ÿæˆç­”æ¡ˆ</button>
                </div>
                <div id="result-3" class="ai-result-display" style="display:none;"></div>
            </div>

            <div id="tab2" class="tab-content">
                <h2>åŸæ–‡</h2>
                <textarea name="original-text" id="original-text" placeholder="è¯·è¾“å…¥åŸæ–‡" required onchange="updateTranslations()"></textarea>

                <h2>ç¿»è¯‘æ–¹å‘</h2>
                <select name="translation-direction" id="translation-direction" onchange="updateTranslations()">
                    <option value="" disabled selected>è¯·é€‰æ‹©ç¿»è¯‘æ–¹å‘</option>
                    <option value="cn">ç¿»è¯‘æˆä¸­æ–‡</option>
                    <option value="en">ç¿»è¯‘æˆè‹±æ–‡</option>
                </select>

                <h2>1. é€å¥ç¿»è¯‘</h2>
                <div id="sentence-by-sentence" class="dynamic-display"></div>
                <div class="btn-group">
                    <button onclick="copyToClipboard('#sentence-by-sentence')" class="copy-button">å¤åˆ¶æç¤ºè¯</button>
                    <button onclick="callAI('sentence-by-sentence', 'result-trans-1')" class="run-ai-button">ğŸ¤– AI ç”Ÿæˆç­”æ¡ˆ</button>
                </div>
                <div id="result-trans-1" class="ai-result-display" style="display:none;"></div>

                <h2>2. å…¨æ–‡ç¿»è¯‘</h2>
                <div id="full-translation" class="dynamic-display"></div>
                <div class="btn-group">
                    <button onclick="copyToClipboard('#full-translation')" class="copy-button">å¤åˆ¶æç¤ºè¯</button>
                    <button onclick="callAI('full-translation', 'result-trans-2')" class="run-ai-button">ğŸ¤– AI ç”Ÿæˆç­”æ¡ˆ</button>
                </div>
                <div id="result-trans-2" class="ai-result-display" style="display:none;"></div>

                <h2>3. ç²¾å‡†ç¿»è¯‘</h2>
                <div id="precise-translation" class="dynamic-display"></div>
                <div class="btn-group">
                    <button onclick="copyToClipboard('#precise-translation')" class="copy-button">å¤åˆ¶æç¤ºè¯</button>
                    <button onclick="callAI('precise-translation', 'result-trans-3')" class="run-ai-button">ğŸ¤– AI ç”Ÿæˆç­”æ¡ˆ</button>
                </div>
                <div id="result-trans-3" class="ai-result-display" style="display:none;"></div>
            </div>

            <div id="tab3" class="tab-content">
                <h2>ğŸ‘ï¸ AI è§†è§‰è¯†åˆ« (æ”¯æŒæ‰‹å†™/å…¬å¼/æ‹ç…§)</h2>
                
                <div class="input-methods">
                    <div class="input-option selected" id="opt-file" onclick="toggleInputMethod('file')">ğŸ“‚ æ–‡ä»¶ä¸Šä¼ </div>
                    <div class="input-option" id="opt-camera" onclick="toggleInputMethod('camera')">ğŸ“¸ æ‹ç…§ä¸Šä¼ </div>
                </div>

                <div class="vision-container">
                    <div id="file-upload-area">
                        <input type="file" id="vision-file-input" accept="image/*" onchange="handleFileSelect(event)">
                        <p style="color:#888; margin-top:10px;">æ”¯æŒ JPG, PNG, GIF</p>
                    </div>

                    <div id="camera-area" style="display:none; width:100%; text-align:center;">
                        <video id="camera-stream" autoplay playsinline></video>
                        <div style="margin-top:10px;">
                            <button id="btn-start-camera" class="camera-btn" onclick="startCamera()">ğŸ”Œ æ‰“å¼€æ‘„åƒå¤´</button>
                            <button id="btn-take-photo" class="camera-btn" onclick="takePhoto()" style="display:none;">ğŸ”˜ æ‹ç…§</button>
                            <button id="btn-retake" onclick="resetCamera()" style="display:none; background:#999;">ğŸ”„ é‡æ‹</button>
                        </div>
                    </div>

                    <img id="preview-image" alt="Preview">
                    <canvas id="canvas-capture"></canvas> </div>

                <div class="btn-group">
                    <button id="btn-run-vision" onclick="runAIVision()" class="run-ai-button">ğŸš€ AI è¯†åˆ«å†…å®¹</button>
                </div>

                <div id="vision-status" class="ocr-status"></div>

                <h2>è¯†åˆ«ç»“æœ</h2>
                <textarea id="vision-result" placeholder="AI è¯†åˆ«åˆ°çš„æ–‡å­—å†…å®¹å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ..."></textarea>
                
                <div class="btn-group">
                    <button onclick="copyVisionResult()" class="copy-button">å¤åˆ¶ç»“æœ</button>
                    <button onclick="sendVisionToTab1()" class="action-button">ğŸ“ å‘é€åˆ°[å†™ä½œ/æ‰¹æ”¹]</button>
                    <button onclick="sendVisionToTab2()" class="action-button">ğŸŒ å‘é€åˆ°[ç¿»è¯‘]</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡å­˜å‚¨å›¾ç‰‡ Base64
        let currentImageBase64 = null;
        let cameraStream = null;

        // --- é¡µé¢åˆå§‹åŒ– ---
        window.onload = function() {
            if(localStorage.getItem('ai_api_url')) document.getElementById('api-url').value = localStorage.getItem('ai_api_url');
            if(localStorage.getItem('ai_api_key')) document.getElementById('api-key').value = localStorage.getItem('ai_api_key');
            if(localStorage.getItem('ai_model_name')) document.getElementById('model-name').value = localStorage.getItem('ai_model_name');
            updateDynamicText();
        }

        function saveApiSettings() {
            localStorage.setItem('ai_api_url', document.getElementById('api-url').value);
            localStorage.setItem('ai_api_key', document.getElementById('api-key').value);
            localStorage.setItem('ai_model_name', document.getElementById('model-name').value);
        }

        // --- è§†è§‰è¯†åˆ«åŠŸèƒ½ (Vision API) ---

        // åˆ‡æ¢ä¸Šä¼ æ–¹å¼
        function toggleInputMethod(method) {
            const fileArea = document.getElementById('file-upload-area');
            const cameraArea = document.getElementById('camera-area');
            const optFile = document.getElementById('opt-file');
            const optCamera = document.getElementById('opt-camera');
            const previewImg = document.getElementById('preview-image');

            // é‡ç½®çŠ¶æ€
            stopCamera();
            currentImageBase64 = null;
            previewImg.style.display = 'none';
            document.getElementById('vision-result').value = '';
            document.getElementById('vision-status').textContent = '';

            if (method === 'file') {
                fileArea.style.display = 'block';
                cameraArea.style.display = 'none';
                optFile.classList.add('selected');
                optCamera.classList.remove('selected');
                document.getElementById('vision-file-input').value = ''; 
            } else {
                fileArea.style.display = 'none';
                cameraArea.style.display = 'block';
                optFile.classList.remove('selected');
                optCamera.classList.add('selected');
                document.getElementById('btn-start-camera').style.display = 'inline-flex';
                document.getElementById('btn-take-photo').style.display = 'none';
                document.getElementById('btn-retake').style.display = 'none';
                document.getElementById('camera-stream').style.display = 'none';
            }
        }

        // å¤„ç†æ–‡ä»¶é€‰æ‹©
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                processImageFile(file);
            }
        }

        // å°†æ–‡ä»¶è½¬ä¸º Base64 å¹¶é¢„è§ˆ
        function processImageFile(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    // å‹ç¼©é€»è¾‘
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;
                    
                    const maxSize = 1500;
                    if (width > height && width > maxSize) {
                        height *= maxSize / width;
                        width = maxSize;
                    } else if (height > maxSize) {
                        width *= maxSize / height;
                        height = maxSize;
                    }

                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);

                    currentImageBase64 = canvas.toDataURL('image/jpeg', 0.8);
                    
                    const previewImg = document.getElementById('preview-image');
                    previewImg.src = currentImageBase64;
                    previewImg.style.display = 'block';
                }
                img.src = e.target.result;
            }
            reader.readAsDataURL(file);
        }

        // --- æ‘„åƒå¤´é€»è¾‘ ---
        async function startCamera() {
            const video = document.getElementById('camera-stream');
            try {
                cameraStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment' } 
                });
                video.srcObject = cameraStream;
                video.style.display = 'block';
                document.getElementById('btn-start-camera').style.display = 'none';
                document.getElementById('btn-take-photo').style.display = 'inline-flex';
            } catch (err) {
                alert("æ— æ³•æ‰“å¼€æ‘„åƒå¤´: " + err.message + "\n(æ³¨æ„ï¼šæµè§ˆå™¨é€šå¸¸è¦æ±‚ https æˆ– localhost æ‰èƒ½ä½¿ç”¨æ‘„åƒå¤´)");
            }
        }

        function takePhoto() {
            const video = document.getElementById('camera-stream');
            const canvas = document.getElementById('canvas-capture');
            const previewImg = document.getElementById('preview-image');

            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);

            stopCamera();

            currentImageBase64 = canvas.toDataURL('image/jpeg', 0.8);
            
            video.style.display = 'none';
            previewImg.src = currentImageBase64;
            previewImg.style.display = 'block';
            document.getElementById('btn-take-photo').style.display = 'none';
            document.getElementById('btn-retake').style.display = 'inline-flex';
        }

        function stopCamera() {
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }
        }

        function resetCamera() {
            document.getElementById('preview-image').style.display = 'none';
            document.getElementById('btn-retake').style.display = 'none';
            startCamera();
        }

        // --- è°ƒç”¨ AI è¿›è¡Œè¯†åˆ« ---
        async function runAIVision() {
            if (!currentImageBase64) {
                alert("è¯·å…ˆä¸Šä¼ å›¾ç‰‡æˆ–æ‹ç…§ï¼");
                return;
            }

            const btn = document.getElementById('btn-run-vision');
            const status = document.getElementById('vision-status');
            const resultArea = document.getElementById('vision-result');
            let apiUrl = document.getElementById('api-url').value.trim();
            const apiKey = document.getElementById('api-key').value.trim();
            const modelName = document.getElementById('model-name').value.trim();

            if (!apiKey) {
                alert("è¯·åœ¨é¡¶éƒ¨å¡«å†™ API Key");
                return;
            }

            saveApiSettings();

            btn.disabled = true;
            btn.innerHTML = '<span class="loading-spinner"></span> AI æ­£åœ¨è¯†åˆ«ä¸­...';
            status.textContent = "æ­£åœ¨ä¸Šä¼ å›¾ç‰‡å¹¶åˆ†æå†…å®¹...";
            resultArea.value = "";

            try {
                apiUrl = apiUrl.replace(/\/+$/, "");
                let endpoint = apiUrl;
                if (!endpoint.includes('/chat/completions')) {
                    if (endpoint.endsWith('/v1')) endpoint += '/chat/completions';
                    else endpoint += '/v1/chat/completions';
                }

                // --- ä¿®æ”¹åçš„ Prompt ---
                const ocrPrompt = `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„OCRï¼ˆå…‰å­¦å­—ç¬¦è¯†åˆ«ï¼‰å¼•æ“ï¼Œè¯·ä¸¥æ ¼æŒ‰ç…§å›¾ç‰‡ä¸­çš„åŸæ–‡è¿›è¡Œé€å­—è½¬å½•ã€‚è¦æ±‚å¦‚ä¸‹ï¼š
1. åŸæ ·è¾“å‡ºï¼šä¸è¦ä¿®æ”¹ä»»ä½•æ‹¼å†™é”™è¯¯ã€è¯­æ³•é”™è¯¯æˆ–æ ‡ç‚¹ç¬¦å·ï¼Œå³ä½¿åŸæ–‡æ˜¯é”™çš„ä¹Ÿè¦ç…§æŠ„ï¼›
2. å®Œæ•´æ€§ï¼šä¸è¦é—æ¼ä»»ä½•æ–‡å­—ï¼ŒåŒ…æ‹¬é¡µçœ‰ã€é¡µè„šã€é¡µç å’Œå¾®å°çš„æ³¨é‡Šï¼›
3. æ— åºŸè¯ï¼šç›´æ¥è¾“å‡ºè¯†åˆ«åçš„æ–‡æœ¬ï¼Œä¸è¦åŒ…å«â€œå¥½çš„â€ã€â€œè¿™æ˜¯å›¾ç‰‡å†…å®¹â€ç­‰ä»»ä½•å¼€åœºç™½æˆ–ç»“æŸè¯­ï¼›
4. æ— æ³•è¯†åˆ«çš„å¤„ç†ï¼šå¦‚æœé‡åˆ°å®Œå…¨æ— æ³•è¾¨è®¤çš„å­—è¿¹ï¼Œè¯·ä½¿ç”¨ [?] ä»£æ›¿ï¼Œä¸è¦çŒœæµ‹ï¼›
5. å¦‚æœæ˜¯æ•°å­¦å…¬å¼ï¼Œè¯·ä½¿ç”¨æ ‡å‡†æ ¼å¼è¾“å‡ºï¼›
6. å¦‚æœæ˜¯è¡¨æ ¼ï¼Œè¯·è¿˜åŸä¸ºMarkdownè¡¨æ ¼ï¼›
7. å¦‚æœæ˜¯æ‰‹å†™ä½“ï¼Œè¯·å°½é‡å‡†ç¡®è¯†åˆ«ã€‚`;

                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: modelName,
                        messages: [
                            {
                                role: "user",
                                content: [
                                    { type: "text", text: ocrPrompt },
                                    { type: "image_url", image_url: { url: currentImageBase64 } }
                                ]
                            }
                        ],
                        max_tokens: 3000
                    })
                });

                if (!response.ok) {
                    const errText = await response.text();
                    throw new Error(`API é”™è¯¯ (${response.status}): ${errText}`);
                }

                const data = await response.json();
                const content = data.choices[0].message.content;
                
                resultArea.value = content;
                status.innerHTML = `<span style="color:green">âœ… è¯†åˆ«æˆåŠŸï¼</span>`;

            } catch (err) {
                console.error(err);
                status.innerHTML = `<span style="color:red">âŒ è¯†åˆ«å¤±è´¥: ${err.message}</span>`;
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'ğŸš€ AI è¯†åˆ«å†…å®¹';
            }
        }

        function copyVisionResult() {
            const text = document.getElementById('vision-result').value;
            if(!text) return alert("æ²¡æœ‰å†…å®¹");
            navigator.clipboard.writeText(text).then(() => alert('å·²å¤åˆ¶'));
        }

        function sendVisionToTab1() {
            const text = document.getElementById('vision-result').value;
            if(!text) return alert("æ— å†…å®¹");
            switchTab({target: document.querySelector('button[onclick*="tab1"]')}, 'tab1');
            document.getElementById('essay-content').value = text;
            updateDynamicText();
            document.getElementById('essay-content').scrollIntoView({behavior: 'smooth'});
        }

        function sendVisionToTab2() {
            const text = document.getElementById('vision-result').value;
            if(!text) return alert("æ— å†…å®¹");
            switchTab({target: document.querySelector('button[onclick*="tab2"]')}, 'tab2');
            document.getElementById('original-text').value = text;
            updateTranslations();
            document.getElementById('original-text').scrollIntoView({behavior: 'smooth'});
        }

        // --- åŸºç¡€ UI é€»è¾‘ ---
        function switchTab(event, tabId) {
            const target = event.target || event;
            const tabButtons = document.querySelectorAll('.tab-btn');
            const tabContents = document.querySelectorAll('.tab-content');

            tabButtons.forEach(button => button.classList.remove('active'));
            tabContents.forEach(content => content.classList.remove('active'));

            if (target.classList.contains('tab-btn')) {
                target.classList.add('active');
            } else {
                const index = tabId === 'tab1' ? 0 : (tabId === 'tab2' ? 1 : 2);
                tabButtons[index].classList.add('active');
            }
            document.getElementById(tabId).classList.add('active');
            
            // å¦‚æœåˆ‡æ¢å‡º Tab3ï¼Œå…³é—­æ‘„åƒå¤´ä»¥çœç”µ
            if(tabId !== 'tab3') stopCamera();
        }

        async function callAI(promptSourceId, resultTargetId) {
            const promptText = document.getElementById(promptSourceId).textContent;
            const resultBox = document.getElementById(resultTargetId);
            let apiUrl = document.getElementById('api-url').value.trim();
            const apiKey = document.getElementById('api-key').value.trim();
            const modelName = document.getElementById('model-name').value.trim();
            const button = document.querySelector(`button[onclick="callAI('${promptSourceId}', '${resultTargetId}')"]`);

            if (!apiKey) {
                alert('è¯·å…ˆåœ¨é¡¶éƒ¨å¡«å†™ API Keyï¼');
                return;
            }
            if (promptText.includes('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯')) {
                alert('è¯·å…ˆå¡«å†™å®Œæ•´è¡¨å•ä¿¡æ¯ç”Ÿæˆæç¤ºè¯ï¼');
                return;
            }
            
            saveApiSettings();

            resultBox.style.display = 'block';
            resultBox.innerHTML = '<div style="text-align:center; color:#666;"><span class="loading-spinner loading-spinner-dark"></span> æ­£åœ¨æ€è€ƒä¸­...</div>';
            button.disabled = true;

            try {
                apiUrl = apiUrl.replace(/\/+$/, "");
                let endpoint = apiUrl;
                if (!endpoint.includes('/chat/completions')) {
                    if (endpoint.endsWith('/v1')) endpoint += '/chat/completions';
                    else endpoint += '/v1/chat/completions';
                }

                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
                    body: JSON.stringify({
                        model: modelName,
                        messages: [{ role: "user", content: promptText }],
                        temperature: 0.7
                    })
                });

                if (!response.ok) throw new Error(await response.text());
                const data = await response.json();
                resultBox.innerHTML = marked.parse(data.choices[0].message.content);

            } catch (error) {
                resultBox.innerHTML = `<div style="color:red">${error.message}</div>`;
            } finally {
                button.disabled = false;
            }
        }

        function updateDynamicText() {
            const gradeSelect = document.getElementById('grade-select');
            const subjectSelect = document.getElementById('subject-select');
            const writingRequirements = document.getElementById('writing-requirements').value;
            const essayTitle = document.getElementById('essay-title').value;
            const essayContent = document.getElementById('essay-content').value;
            const mathProblem = document.getElementById('math-problem').value;
            const englishProblem = document.getElementById('english-problem').value;
            const dynamicTextElem = document.getElementById('dynamic-text');
            const newDynamicTextElem = document.getElementById('new-dynamic-text');
            const thirdDynamicTextElem = document.getElementById('third-dynamic-text');
            const numberInput = parseInt(document.getElementById('number-input').value) || 0;
            const genreSelect = document.getElementById('genre-select');

            const grade = gradeSelect.value;
            const subject = subjectSelect.value;

            const defaultContent = 'è¯·å¡«å†™å®Œæ•´ä¿¡æ¯ä»¥æŸ¥çœ‹åŠ¨æ€å†…å®¹ï¼';

            if (grade && subject) {
                const subjectText = subject === 'è¯­æ–‡' ? 'å†™ä½œ' : subject;
                const genreValue = genreSelect.value;
                const selectedGenreText = genreSelect.selectedIndex >=0 ? genreSelect.options[genreSelect.selectedIndex].text : '';

                let additionalContent = [];

                if (subject === 'è¯­æ–‡') {
                    additionalContent = [
                        `**å†™ä½œè¦æ±‚ï¼š** ${writingRequirements}`,
                        `**ä½œæ–‡æ ‡é¢˜ï¼š** ${essayTitle}`,
                        `**ä½œæ–‡æ­£æ–‡ï¼š** ${essayContent}`,
                        `æˆ‘æ˜¯ä¸€å${grade}çš„å­¦ç”Ÿï¼Œæˆ‘æƒ³å­¦ä¹ å¥½${subjectText}ã€‚æˆ‘å¸Œæœ›ä½ æ‰®æ¼”ä¸€åæ•™å­¦ç»éªŒéå¸¸ä¸°å¯Œçš„è¯­æ–‡è€å¸ˆï¼Œä½ æ“…é•¿è¯­æ³•ã€ä¿®è¾åˆ†æã€å†…å®¹è¯„ä¼°ã€é€»è¾‘æ€ç»´ã€é¼“åŠ±å­¦ç”Ÿã€æä¾›å…·ä½“å»ºè®®ã€ä¸ªæ€§åŒ–åé¦ˆã€æ²Ÿé€šæŠ€å·§ç­‰ï¼Œå¯æœ‰æ•ˆæ‰¹æ”¹ä½œæ–‡å¹¶å¸®åŠ©å­¦ç”Ÿæé«˜å†™ä½œæ°´å¹³ã€‚å½“æˆ‘æå‡ºå…³äºä½œæ–‡çš„é—®é¢˜æ—¶ï¼Œè¯·å¯¹ä½œæ–‡ä¸€å¥ä¸€å¥æ–Ÿé…Œï¼Œå¹¶æŒ‰ç…§ä»¥ä¸‹æ ¼å¼äºˆä»¥æ‰¹æ”¹ï¼Œè¾“å‡ºå†…å®¹ä½¿ç”¨Markdownè¿›è¡Œæ¸²æŸ“ã€‚`,
                        '**ä¸€ã€ç»¼åˆè¯„è¯­**',
                        `è¯·ç»“åˆ${selectedGenreText}çš„æ–‡ä½“å’Œå†™ä½œè¦æ±‚å¯¹ä½œæ–‡çš„å†…å®¹ã€è¡¨è¾¾ã€ä¸»é¢˜ã€ç»“æ„ã€æƒ…æ„Ÿã€è¯­æ³•ç­‰æ–¹é¢ä»¥ç§¯æè‚¯å®šçš„è¯­æ°”ç»™å‡ºå®¢è§‚è¯¦å®çš„è¯„è¯­ï¼Œè¯„è¯­å­—æ•°ä¸å°‘äº50å­—ï¼›`,
                        '**äºŒã€æ€»ä½“è¯„åˆ†**',
                        'ä»¥ç™¾åˆ†åˆ¶ç»™ä½œæ–‡è¯„åˆ†ï¼›',
                        '**ä¸‰ã€ä¸è¶³ä¹‹å¤„**',
                        'ç”Ÿæˆä¸€ä¸ªè¡¨æ ¼ï¼Œæ¨ªè½´ä¸ºåºå·ã€ç±»åˆ«ã€é”™è¯¯/ä¸è¶³ä¹‹å¤„ã€ä¿®æ”¹å»ºè®®ï¼Œç«–è½´ç¬¬ä¸€åˆ—ä¸ºæ•°å­—1è‡³10ï¼›ç»“åˆ' + selectedGenreText + 'çš„æ–‡ä½“å’Œå†™ä½œè¦æ±‚åˆ†åˆ«å¯¹â€œä¸»é¢˜å¥‘åˆåº¦ã€ç»“æ„ä¸ç»„ç»‡ã€å†…å®¹ä¸è§‚ç‚¹ã€é€»è¾‘è¿è´¯æ€§ã€æªè¾å‡†ç¡®æ€§ã€è¯­è¨€ä¸æƒ…æ„Ÿã€ä¿®è¾å’Œæå†™ã€ç”¨ä¾‹ä¸ç»†èŠ‚ã€åˆ›æ„ä¸æƒ³è±¡ã€è¯­æ³•ä¸æ ‡ç‚¹â€10ä¸ªç±»åˆ«é€æ¡æå‡ºä¸è¶³ï¼›',
                        '**å››ã€æå‡å»ºè®®**',
                        '**äº”ã€å®¡é¢˜ç«‹æ„**',
                        '**å…­ã€è°‹ç¯‡å¸ƒå±€**',
                        '**ä¸ƒã€é€‰æç”¨æ**',
                        '**å…«ã€è¯­è¨€ä¿®è¾**',
                        '**ä¹ã€åˆ†æè¯´ç†**',
                        '**åã€å†™ä½œæçº²**',
                        '**åä¸€ã€å†™ä½œæŠ€æ³•**',
                        '**åäºŒã€èŒƒæ–‡**',
                        `æä¾›ä¿®æ”¹å¹¶æ¶¦è‰²åçš„èŒƒæ–‡ï¼ŒèŒƒæ–‡å­—æ•°ä¸å°‘äº${numberInput}å­—ä¸”ä¸è¶…è¿‡${Math.floor(numberInput * 1.1)}å­—ï¼›æ ‡é¢˜è‡ªæ‹Ÿï¼›èŒƒæ–‡ç»“æŸåè½æ¬¾â€œ**ä¿®è¾åç« æ–‡åŠ**â€ã€‚`
                    ];
                } else if (subject === 'æ•°å­¦') {
                    additionalContent = [
                        `**æ•°å­¦é—®é¢˜ï¼š** ${mathProblem}`,
                        `æˆ‘æ˜¯ä¸€å${grade}çš„å­¦ç”Ÿï¼Œæˆ‘æƒ³å­¦ä¹ å¥½æ•°å­¦ã€‚æˆ‘å¸Œæœ›ä½ æ‰®æ¼”ä¸€åæ•™å­¦ç»éªŒéå¸¸ä¸°å¯Œçš„æ•°å­¦è€å¸ˆï¼Œä½ æ“…é•¿æ•°å­¦æ¦‚å¿µè§£é‡Šã€é—®é¢˜åˆ†æã€æ•™å­¦æ–¹æ³•å¤šæ ·æ€§ã€ä¸ªæ€§åŒ–æŒ‡å¯¼ã€çº æ­£é”™è¯¯ã€åŸ¹å…»é—®é¢˜è§£å†³èƒ½åŠ›ä»¥åŠæ¿€å‘å…´è¶£ï¼Œå¯å¸®åŠ©å­¦ç”Ÿæœ‰æ•ˆçš„æé«˜æ•°å­¦æ€ç»´å’Œæ¦‚å¿µç†è§£èƒ½åŠ›ã€‚å½“æˆ‘æå‡ºå…³äºæ•°å­¦çš„é—®é¢˜æ—¶ï¼Œè¯·ä¸€æ­¥ä¸€æ­¥è¿›è¡Œè®¡ç®—ï¼Œå¹¶å°†è®¡ç®—ç»“æœä»£å…¥é¢˜ç›®è¿›è¡ŒéªŒç®—ï¼ŒéªŒç®—æ— è¯¯åè¯·æŒ‰ç…§ä»¥ä¸‹æ ¼å¼äºˆä»¥è§£ç­”ï¼Œè¾“å‡ºå†…å®¹è¯·ä½¿ç”¨æ ‡å‡†æ•°å­¦ç¬¦å·ï¼Œä¸è¦ä½¿ç”¨LaTexæ ¼å¼è¡¨è¾¾ï¼ŒåŒæ—¶ä½¿ç”¨Markdownè¿›è¡Œæ¸²æŸ“ã€‚`,
                        '**ä¸€ã€é¢˜ç›®åˆ†æ**',
                        '**äºŒã€è§£é¢˜æ€è·¯**',
                        '**ä¸‰ã€è§£é¢˜æ–¹æ³•**',
                        '**å››ã€è§£é¢˜æ­¥éª¤**',
                        '**äº”ã€è®¡ç®—è¿‡ç¨‹**',
                        '**å…­ã€æ€»ç»“çŸ¥è¯†ç‚¹**',
                        '**ä¸ƒã€åŒç±»é¢˜å‹**',
                        'æ ¹æ®çŸ¥è¯†ç‚¹å‡º2ä¸ªåŒç±»é¢˜å‹ï¼Œåˆ†åˆ«ç»™å‡ºç­”æ¡ˆã€‚'
                    ];
                } else if (subject === 'è‹±è¯­') {
                    additionalContent = [
                        `**è‹±è¯­é—®é¢˜ï¼š** ${englishProblem}`,
                        `æˆ‘æ˜¯ä¸€å${grade}çš„å­¦ç”Ÿï¼Œæˆ‘æƒ³å­¦ä¹ å¥½è‹±è¯­ã€‚æˆ‘å¸Œæœ›ä½ æ‰®æ¼”ä¸€åæ•™å­¦ç»éªŒéå¸¸ä¸°å¯Œçš„è‹±è¯­è€å¸ˆï¼Œä½ æ“…é•¿è‹±è¯­é—®é¢˜åˆ†æã€æ¸…æ™°è§£é‡Šã€ç¤ºèŒƒè§£ç­”ã€å¼•å¯¼å­¦ç”Ÿç‹¬ç«‹æ€è€ƒå’Œæä¾›ä¸ªæ€§åŒ–æ”¯æŒï¼Œå¯å¸®åŠ©å­¦ç”Ÿæœ‰æ•ˆçš„æé«˜é˜…è¯»ç†è§£èƒ½åŠ›å’Œè¯­æ³•æ°´å¹³ã€‚å½“æˆ‘æå‡ºå…³äºè‹±è¯­çš„é—®é¢˜æ—¶ï¼Œè¯·æŒ‰ç…§ä»¥ä¸‹æ ¼å¼äºˆä»¥è§£ç­”ï¼Œæœ€åè¾“å‡ºå†…å®¹ä½¿ç”¨Markdownè¿›è¡Œæ¸²æŸ“ã€‚`,
                        '**ä¸€ã€è‹±æ±‰ç¿»è¯‘**',
                        'å°†åŸæ–‡ä¸è¯‘æ–‡é€å¥å¯¹ç…§ç¿»è¯‘æˆä¸­æ–‡ï¼ŒæŠŠè‹±è¯­å­—ä½“æ ‡è®°ä¸ºç²—ä½“ï¼›',
                        '**äºŒã€é¢˜ç›®åˆ†æ**',
                        '**ä¸‰ã€è§£é¢˜æ€è·¯**',
                        '**å››ã€è§£é¢˜æ–¹æ³•**',
                        '**äº”ã€è§£é¢˜æ­¥éª¤**',
                        '**å…­ã€æ€»ç»“çŸ¥è¯†ç‚¹**',
                        '**ä¸ƒã€åŒç±»é¢˜å‹**',
                        'æ ¹æ®çŸ¥è¯†ç‚¹å‡º2ä¸ªåŒç±»é¢˜å‹ã€‚'
                    ];
                }

                dynamicTextElem.textContent = additionalContent.join('\n');
            } else {
                dynamicTextElem.textContent = defaultContent;
            }

            newDynamicTextElem.textContent = defaultContent;
            if (grade && subject && (subject === 'è¯­æ–‡' || subject === 'è‹±è¯­')) {
                const selectedGenreText = genreSelect.selectedIndex >=0 ? genreSelect.options[genreSelect.selectedIndex].text : '';
                const minWordCount = numberInput;
                const maxWordCount = Math.floor(numberInput * 1.1);

                const newDynamicContent = [
                    `**å†™ä½œè¦æ±‚ï¼š** ${writingRequirements}`,
                    "",
                    `æˆ‘æ˜¯ä¸€å${grade}çš„å­¦ç”Ÿï¼Œæˆ‘æƒ³å­¦ä¹ å¥½${subject === 'è¯­æ–‡' ? 'å†™ä½œ' : 'è‹±è¯­'}ã€‚æˆ‘å¸Œæœ›ä½ æ‰®æ¼”ä¸€åæ•™å­¦ç»éªŒéå¸¸ä¸°å¯Œçš„${subject}è€å¸ˆã€‚ä½ æ“…é•¿è¯­æ³•ã€ä¿®è¾åˆ†æã€å†…å®¹è¯„ä¼°ã€é€»è¾‘æ€ç»´ã€é¼“åŠ±å­¦ç”Ÿã€æä¾›å…·ä½“å»ºè®®ã€ä¸ªæ€§åŒ–åé¦ˆã€æ²Ÿé€šæŠ€å·§ç­‰ï¼Œå¯å¸®åŠ©å­¦ç”Ÿæœ‰æ•ˆæé«˜å†™ä½œæ°´å¹³ã€‚`,
                    "",
                    `è¯·ç”¨${grade}å­¦ç”Ÿçš„å†™ä½œé£æ ¼ï¼ŒæŒ‰ç…§å®¡é¢˜ç«‹æ„ã€è°‹ç¯‡å¸ƒå±€ã€é€‰æç”¨æã€è¯­è¨€ä¿®è¾ã€åˆ†æè¯´ç†ç­‰äº”å¤§å†™ä½œå…³é”®å› ç´ ï¼Œä¸€æ­¥ä¸€æ­¥æ€è€ƒï¼Œç»“åˆ${selectedGenreText}çš„æ–‡ä½“å’Œå†™ä½œè¦æ±‚ï¼Œå†™ä¸€ç¯‡å†…å®¹æ–°é¢–ã€è¡¨è¾¾æ¸…æ™°ã€ä¸»é¢˜é²œæ˜ã€ç»“æ„å®Œæ•´ã€æƒ…æ„ŸçœŸå®çš„ä½œæ–‡ï¼Œæ ‡é¢˜è‡ªæ‹Ÿï¼Œä½œæ–‡å­—æ•°ä¸å°‘äº${minWordCount}å­—ä¸”ä¸è¶…è¿‡${maxWordCount}å­—ï¼Œå†™ä½œç»“æŸåè½æ¬¾â€œ**ä¿®è¾åç« æ–‡åŠ**â€ï¼Œè¾“å‡ºå†…å®¹ä½¿ç”¨Markdownè¿›è¡Œæ¸²æŸ“ã€‚`
                ];

                newDynamicTextElem.textContent = newDynamicContent.join('\n');
            }

            thirdDynamicTextElem.textContent = defaultContent;
            if (grade && subject && (subject === 'è¯­æ–‡' || subject === 'è‹±è¯­')) {
                const selectedGenreText = genreSelect.selectedIndex >=0 ? genreSelect.options[genreSelect.selectedIndex].text : '';
                const minWordCount = numberInput;
                const maxWordCount = Math.floor(numberInput * 1.1);

                const thirdDynamicContent = [
                    `æˆ‘å¸Œæœ›ä½ æ‰®æ¼”ä¸€åæ•™å­¦ç»éªŒéå¸¸ä¸°å¯Œçš„${subject}è€å¸ˆã€‚ä½ æ“…é•¿è¯­æ³•ã€ä¿®è¾åˆ†æã€å†…å®¹è¯„ä¼°ã€é€»è¾‘æ€ç»´ã€é¼“åŠ±å­¦ç”Ÿã€æä¾›å…·ä½“å»ºè®®ã€ä¸ªæ€§åŒ–åé¦ˆã€æ²Ÿé€šæŠ€å·§ç­‰ï¼Œå¯å¸®åŠ©å­¦ç”Ÿæœ‰æ•ˆæé«˜å†™ä½œæ°´å¹³ã€‚`,
                    "",
                    `è¯·æ ¹æ®${grade}å­¦ç”Ÿçš„å†™ä½œæ°´å¹³ï¼Œä¸ºå­¦ç”Ÿå‡ºä¸€ä¸ª${subject}ä½œæ–‡ä¹ é¢˜ï¼Œç»“åˆ${selectedGenreText}çš„æ–‡ä½“ï¼Œé€‰æ‹©ä¸€ä¸ªä¸»é¢˜ã€å®šä¹‰å†™ä½œä»»åŠ¡ã€ç¡®å®šä½œæ–‡è¦æ±‚ï¼Œä½œæ–‡å­—æ•°ä¸å°‘äº${minWordCount}å­—ä¸”ä¸è¶…è¿‡${maxWordCount}å­—ï¼Œè¾“å‡ºå†…å®¹ä½¿ç”¨Markdownè¿›è¡Œæ¸²æŸ“ã€‚`
                ];

                thirdDynamicTextElem.textContent = thirdDynamicContent.join('\n');
            }
        }

        function updateTranslations() {
            const originalText = document.getElementById('original-text').value;
            const translationDirection = document.getElementById('translation-direction').value;
            const sentenceBySentence = document.getElementById('sentence-by-sentence');
            const fullTranslation = document.getElementById('full-translation');
            const preciseTranslation = document.getElementById('precise-translation');

            const defaultTranslationContent = 'è¯·å¡«å†™å®Œæ•´ä¿¡æ¯ä»¥æŸ¥çœ‹ç¿»è¯‘å†…å®¹ï¼';

            sentenceBySentence.textContent = defaultTranslationContent;
            fullTranslation.textContent = defaultTranslationContent;
            preciseTranslation.textContent = defaultTranslationContent;

            if (translationDirection && translationDirection.trim() !== '') {
                sentenceBySentence.textContent = [
                    `æˆ‘ä»äº‹ç¿»è¯‘å·¥ä½œï¼Œæˆ‘æƒ³å­¦ä¹ å¥½ç¿»è¯‘ã€‚æˆ‘å¸Œæœ›ä½ æ‰®æ¼”ä¸€åç»éªŒä¸°å¯Œçš„è¯­è¨€ä¸“å®¶ï¼Œæ“…é•¿å¤šç§è¯­è¨€çš„ç¿»è¯‘å·¥ä½œï¼Œèƒ½å¤Ÿç†è§£å¹¶å‡†ç¡®ç¿»è¯‘å„ç§è¯­è¨€ï¼ŒåŒ…æ‹¬ä½†ä¸é™äºä¸“ä¸šæœ¯è¯­ã€ä¿šè¯­å’Œæ–‡åŒ–ç‰¹å®šè¡¨è¾¾ã€‚å½“æˆ‘æä¾›ä»»æ„è¯­è¨€åŸæ–‡æ—¶ï¼Œè¯·å¯¹åŸæ–‡é€å¥ç†è§£ï¼Œå¹¶æŒ‰ç…§ä»¥ä¸‹æ ¼å¼äºˆä»¥ç¿»è¯‘ï¼Œè¾“å‡ºå†…å®¹ä½¿ç”¨Markdownè¿›è¡Œæ¸²æŸ“ã€‚`,
                    "",
                    `**ä¸€ã€åŸæ–‡**`,
                    `**${originalText}**`,
                    "",
                    `**äºŒã€è¯‘æ–‡**`,
                    `1.å°†åŸæ–‡${translationDirection === 'cn' ? 'ç¿»è¯‘æˆä¸­æ–‡' : 'ç¿»è¯‘æˆè‹±æ–‡'}ï¼›`,
                    `2.å¯¹ç¿»è¯‘çš„ç»“æœè¿›è¡Œæ ¡å¯¹ï¼Œç¡®ä¿ç¿»è¯‘å‡†ç¡®ã€æµç•…ä¸”è´´è¿‘åŸæ–‡çš„æ„å¢ƒï¼›`,
                    `3.å¦‚æœåŸæ–‡ä¸­åŒ…å«ä¸“æœ‰åè¯ã€äººåç­‰ï¼Œéœ€åœ¨ç¿»è¯‘æ–‡æœ¬åä»¥æ‹¬å·å½¢å¼ç»™å‡ºåŸæ–‡å‚è€ƒï¼›`,
                    `4.ç¿»è¯‘å®Œæˆåè½æ¬¾â€œ**ä¿®è¾åç« æ–‡åŠ**â€ã€‚`,
                    "",
                    `**ç›´è¯‘ç‰ˆæœ¬**å¿ å®äºåŸæ–‡çš„å­—é¢æ„æ€ï¼Œé€‚ç”¨äºæ–‡æœ¬çš„ç›´æ¥å¯¹åº”ç¿»è¯‘ï¼›`,
                    `**æ„è¯‘ç‰ˆæœ¬**ä¾§é‡äºä¼ è¾¾åŸæ–‡çš„å†…åœ¨æ„ä¹‰å’Œæƒ…æ„Ÿï¼Œé€‚ç”¨äºä¿æŒåŸæ–‡çš„æƒ…æ„Ÿè‰²å½©å’Œæ–‡åŒ–èƒŒæ™¯ï¼›`,
                    `**ç»¼åˆç›´è¯‘æ„è¯‘ç‰ˆæœ¬**ç»“åˆç›´è¯‘å’Œæ„è¯‘çš„ä¼˜ç‚¹ï¼Œåˆ›é€ ä¸€ä¸ªæ—¢å¿ å®åŸæ–‡åˆèƒ½æµç•…è¡¨è¾¾çš„ç¿»è¯‘ã€‚`
                ].join('\n');

                fullTranslation.textContent = [
                    `æˆ‘ä»äº‹ç¿»è¯‘å·¥ä½œï¼Œæˆ‘æƒ³å­¦ä¹ å¥½ç¿»è¯‘ã€‚æˆ‘å¸Œæœ›ä½ æ‰®æ¼”ä¸€åç»éªŒä¸°å¯Œçš„è¯­è¨€ä¸“å®¶ï¼Œæ“…é•¿å¤šç§è¯­è¨€çš„ç¿»è¯‘å·¥ä½œï¼Œèƒ½å¤Ÿç†è§£å¹¶å‡†ç¡®ç¿»è¯‘å„ç§è¯­è¨€ï¼ŒåŒ…æ‹¬ä½†ä¸é™äºä¸“ä¸šæœ¯è¯­ã€ä¿šè¯­å’Œæ–‡åŒ–ç‰¹å®šè¡¨è¾¾ã€‚å½“æˆ‘æä¾›ä»»æ„è¯­è¨€åŸæ–‡æ—¶ï¼Œè¯·å¯¹åŸæ–‡é€å¥ç†è§£ï¼Œå¹¶æŒ‰ç…§ä»¥ä¸‹æ ¼å¼äºˆä»¥ç¿»è¯‘ï¼Œè¾“å‡ºå†…å®¹ä½¿ç”¨Markdownè¿›è¡Œæ¸²æŸ“ã€‚`,
                    "",
                    `**ä¸€ã€åŸæ–‡**`,
                    `**${originalText}**`,
                    "",
                    `**äºŒã€è¯‘æ–‡**`,
                    `1.æ ¹æ®åŸæ–‡çš„æ ‡ç‚¹ç¬¦å·è¿›è¡Œæ–­å¥ï¼Œå°†åŸæ–‡æ–­å¥ä¸è¯‘æ–‡é€å¥å¯¹ç…§${translationDirection === 'cn' ? 'ç¿»è¯‘æˆä¸­æ–‡' : 'ç¿»è¯‘æˆè‹±æ–‡'}ï¼›`,
                    `2.ç”Ÿæˆä¸€ä¸ªè¡¨æ ¼ï¼Œæ¨ªè½´ä¸ºåŸæ–‡æ–­å¥ã€ç›´è¯‘ç‰ˆæœ¬ã€æ„è¯‘ç‰ˆæœ¬ã€ç»¼åˆç›´è¯‘æ„è¯‘ç‰ˆæœ¬ï¼Œç«–è½´ç¬¬ä¸€åˆ—ä¸ºåŸæ–‡çš„æ–­å¥ï¼›`,
                    `3.å¯¹ç¿»è¯‘çš„ç»“æœè¿›è¡Œæ ¡å¯¹ï¼Œç¡®ä¿ç¿»è¯‘å‡†ç¡®ã€æµç•…ä¸”è´´è¿‘åŸæ–‡çš„æ„å¢ƒï¼›`,
                    `4.å¦‚æœåŸæ–‡ä¸­åŒ…å«ä¸“æœ‰åè¯ã€äººåç­‰ï¼Œéœ€åœ¨ç¿»è¯‘æ–‡æœ¬åä»¥æ‹¬å·å½¢å¼ç»™å‡ºåŸæ–‡å‚è€ƒï¼›`,
                    `5.ç¿»è¯‘å®Œæˆåè½æ¬¾â€œ**ä¿®è¾åç« æ–‡åŠ**â€ã€‚`,
                    "",
                    `**ç›´è¯‘ç‰ˆæœ¬**`,
                    `- å¿ å®äºåŸæ–‡çš„å­—é¢æ„æ€ï¼Œé€‚ç”¨äºæ–‡æœ¬çš„ç›´æ¥å¯¹åº”ç¿»è¯‘ï¼›`,
                    "",
                    `**æ„è¯‘ç‰ˆæœ¬**`,
                    `- ä¾§é‡äºä¼ è¾¾åŸæ–‡çš„å†…åœ¨æ„ä¹‰å’Œæƒ…æ„Ÿï¼Œé€‚ç”¨äºä¿æŒåŸæ–‡çš„æƒ…æ„Ÿè‰²å½©å’Œæ–‡åŒ–èƒŒæ™¯ï¼›`,
                    "",
                    `**ç»¼åˆç›´è¯‘æ„è¯‘ç‰ˆæœ¬**`,
                    `- ç»“åˆç›´è¯‘å’Œæ„è¯‘çš„ä¼˜ç‚¹ï¼Œåˆ›é€ ä¸€ä¸ªæ—¢å¿ å®åŸæ–‡åˆèƒ½æµç•…è¡¨è¾¾çš„ç¿»è¯‘ã€‚`
                ].join('\n');

                preciseTranslation.textContent = [
                    "## è§’è‰²&ä»»åŠ¡",
                    "### ä»»åŠ¡",
                    `æˆ‘å¸Œæœ›ä½ ä»¥ä¸€ä¸ªä¸“ä¸šç¿»è¯‘å›¢é˜Ÿçš„èº«ä»½ï¼ŒååŠ©å®Œæˆå°†åŸæ–‡${translationDirection === 'cn' ? 'ç¿»è¯‘æˆä¸­æ–‡' : 'ç¿»è¯‘æˆè‹±æ–‡'}çš„ç¿»è¯‘ä»»åŠ¡.`,
                    "### è§’è‰²",
                    "å¯¹äºæ¯ä¸ªç¿»è¯‘ä»»åŠ¡ï¼Œæˆ‘å°†æ‰®æ¼”ä¸‰ä¸ªä¸“å®¶è§’è‰²ï¼Œåˆ†åˆ«è´Ÿè´£ç¿»è¯‘ã€æ ¡å¯¹ä¸æ¶¦è‰²å·¥ä½œï¼š",
                    "1.ç¿»è¯‘ä¸“å®¶ï¼šå…·æœ‰20å¹´ç¿»è¯‘ç»éªŒï¼Œç²¾é€šä¸­è‹±åŒè¯­ï¼Œå¹¶æ‹¥æœ‰ä¸°å¯Œçš„è·¨å­¦ç§‘çŸ¥è¯†ã€‚æ­¤é˜¶æ®µçš„ç›®æ ‡æ˜¯æä¾›ä¸€ä»½æ—¢å¿ å®äºåŸæ–‡ï¼Œåˆåœ¨è¯‘æ–‡ä¸­è¯»èµ·æ¥æµç•…è‡ªç„¶çš„åˆç¨¿ã€‚åœ¨ç¿»è¯‘æ—¶ï¼Œç‰¹åˆ«æ³¨é‡ä¿æŒåŸæ–‡çš„é£æ ¼å’Œè¯­è°ƒã€‚",
                    "2.èµ„æ·±æ ¡å¯¹ç¼–è¾‘ï¼šæ‹¥æœ‰20å¹´ä¸“ä¸šç¼–è¾‘ç»éªŒï¼Œä¸­è‹±æ–‡ç³»æ¯•ä¸šï¼Œå¯¹è¯­æ³•ã€ç”¨è¯æœ‰ç²¾å‡†æŠŠæ¡ã€‚åœ¨æ­¤é˜¶æ®µï¼Œæ‚¨éœ€è¦å¯¹ç¿»è¯‘ç¨¿è¿›è¡Œæ·±åº¦æ ¡å¯¹ï¼ŒåŒ…æ‹¬è¯­æ³•ã€ç”¨è¯ã€é£æ ¼çš„æ ¡æ­£ï¼Œç¡®ä¿ç¿»è¯‘çš„å‡†ç¡®æ€§å’Œæ˜“è¯»æ€§,è¿›è€Œè¾“å‡ºç¬¬äºŒç‰ˆç¿»è¯‘ç¨¿ã€‚",
                    "3.æ¶¦è‰²ä¸“å®¶ï¼šä½œä¸ºä¸€ä½æ‹¥æœ‰20å¹´å†™ä½œç»éªŒçš„è·å¥–ä½œå®¶ï¼Œæ“…é•¿å„ç§é£æ ¼æµæ´¾çš„å†™ä½œã€‚åœ¨æ­¤é˜¶æ®µï¼Œæ‚¨éœ€è¦åœ¨æ ¡å¯¹ç¼–è¾‘æä¾›çš„ç¨¿ä»¶åŸºç¡€ä¸Šï¼Œè¿›è¡Œé£æ ¼ä¸Šçš„æ¶¦è‰²ï¼Œæé«˜æ–‡æœ¬çš„æ–‡å­¦ç¾æ„Ÿï¼ŒåŒæ—¶ä¿æŒåŸæ–‡çš„ä¸“ä¸šæ€§å’Œå‡†ç¡®æ€§ã€‚ä¾‹å¦‚ï¼Œæ¶¦è‰²è¯—æ­Œæ—¶åº”ä½¿ç”¨æ›´ä¼˜ç¾ã€å¯Œæœ‰æ„å¢ƒçš„è¯­è¨€ï¼›æ¶¦è‰²ç§‘æŠ€ç±»æ–‡ç« æ—¶åˆ™åº”ç»´æŒå…¶ä¸“ä¸šæ€§å’Œå‡†ç¡®æ€§ã€‚",
                    "## å·¥ä½œæµç¨‹",
                    "### 1.ç¿»è¯‘é˜¶æ®µ",
                    "å‚ä¸äººï¼šç¿»è¯‘ä¸“å®¶",
                    "è¾“å‡ºç‰©ï¼šç¿»è¯‘ç¨¿ä»¶",
                    "ä»»åŠ¡ï¼šæä¾›å¿ å®åŸæ–‡ä¸”æµç•…çš„è¯‘æ–‡åˆç¨¿ã€‚",
                    "### 2.æ ¡å¯¹é˜¶æ®µ",
                    "å‚ä¸äººï¼šèµ„æ·±æ ¡å¯¹ç¼–è¾‘",
                    "è¾“å‡ºç‰©ï¼šæ ¡å¯¹è¿‡çš„ç¿»è¯‘ç¨¿ä»¶",
                    "ä»»åŠ¡ï¼šæ·±åº¦æ ¡å¯¹åˆç¨¿ï¼Œä¿è¯å‡†ç¡®æ€§å’Œæ˜“è¯»æ€§ã€‚",
                    "### 3.æ¶¦è‰²é˜¶æ®µ",
                    "å‚ä¸äººï¼šæ¶¦è‰²ä¸“å®¶",
                    "è¾“å‡ºç‰©ï¼šæ¶¦è‰²è¿‡åçš„æœ€ç»ˆç¿»è¯‘ç¨¿",
                    "ä»»åŠ¡ï¼šæå‡æ–‡æœ¬çš„é£æ ¼ç¾æ„Ÿï¼ŒåŒæ—¶ä¿æŒä¸“ä¸šæ€§å’Œå‡†ç¡®æ€§ã€‚",
                    "## ä¸‹é¢æˆ‘ä»¬åˆ†åˆ«å¼€å§‹ä¸‰ä¸ªé˜¶æ®µã€‚",
                    `### ${originalText}`
                ].join('\n');
            }
        }
        
        function copyToClipboard(targetId) {
             const content = document.querySelector(targetId).textContent;
             const tempTextArea = document.createElement('textarea');
             tempTextArea.value = content;
             document.body.appendChild(tempTextArea);
             tempTextArea.select();
             document.execCommand('copy');
             document.body.removeChild(tempTextArea);
             alert('å†…å®¹å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
        }

        // é¡µé¢åŠ è½½è§¦å‘ä¸€æ¬¡æ›´æ–°
        updateDynamicText();
    </script>
</body>
</html>